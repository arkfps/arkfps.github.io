<!DOCTYPE html> <html lang=en-GB itemscope itemtype=https://schema.org/BlogPosting prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"> <head> <meta charset=utf-8>  <meta http-equiv=Content-Security-Policy content="default-src https: data: 'unsafe-inline' wss:; form-action https:; block-all-mixed-content; base-uri 'self'; referrer origin-when-cross-origin">  <meta name=viewport content="width=device-width,initial-scale=1">  <title>Using Coverity Scan with AppVeyor</title> <meta itemprop=name content="Using Coverity Scan with AppVeyor"> <meta property=og:title content="Using Coverity Scan with AppVeyor">  <meta name=description content="Unlike Travis CI, AppVeyor currently lacks out of the box integration with Coverity Scan. In this article I’ll show you how to enable Coverity Scan code analysis for your project by injecting custom PowerShell scripts into AppVeyor build process."> <meta itemprop=description content="Unlike Travis CI, AppVeyor currently lacks out of the box integration with Coverity Scan. In this article I’ll show you how to enable Coverity Scan code analysis for your project by injecting custom PowerShell scripts into AppVeyor build process."> <meta property=og:description content="Unlike Travis CI, AppVeyor currently lacks out of the box integration with Coverity Scan. In this article I’ll show you how to enable Coverity Scan code analysis for your project by injecting custom PowerShell scripts into AppVeyor build process.">   <meta name=keywords content="AppVeyor,CI,Coverity,.NET,PowerShell,Static Analysis"> <meta itemprop=keywords content="AppVeyor,CI,Coverity,.NET,PowerShell,Static Analysis">  <meta name=author content="Pavel Frolov"> <link rel=author type=text/plain href=/humans.txt>   <meta property=og:image content=https://thehermeticvault.com/img/pages/codex-hammurabi.jpg> <meta property=og:image:type content="image/jpeg"> <meta property=og:image:width content="1620"> <meta property=og:image:height content="1080">  <meta property=og:site_name content="The Hermetic Vault"> <meta property=og:type content=article> <meta property=og:locale content=en_GB>  <meta property=article:published_time content=2015-01-07T00:00:00+03:00> <meta property=article:modified_time content=2016-02-02T08:45:07+03:00> <meta property=article:author content=https://www.facebook.com/psfrolov> <meta property=article:section content="Software Development"> <meta property=article:tag content=AppVeyor> <meta property=article:tag content=CI> <meta property=article:tag content=Coverity> <meta property=article:tag content=.NET> <meta property=article:tag content=PowerShell> <meta property=article:tag content="Static Analysis">   <meta name=twitter:card content=summary_large_image> <meta name=twitter:site:id content=4133911523> <meta name=twitter:creator:id content=4133911523>  <link rel=apple-touch-icon sizes=57x57 href=/apple-touch-icon-57x57.aaf54ad4.png> <link rel=apple-touch-icon sizes=60x60 href=/apple-touch-icon-60x60.92f40ccf.png> <link rel=apple-touch-icon sizes=72x72 href=/apple-touch-icon-72x72.f13eb2d8.png> <link rel=apple-touch-icon sizes=76x76 href=/apple-touch-icon-76x76.d9913b14.png> <link rel=apple-touch-icon sizes=114x114 href=/apple-touch-icon-114x114.fb7fa749.png> <link rel=apple-touch-icon sizes=120x120 href=/apple-touch-icon-120x120.dc690543.png> <link rel=apple-touch-icon sizes=144x144 href=/apple-touch-icon-144x144.cb6c1692.png> <link rel=apple-touch-icon sizes=152x152 href=/apple-touch-icon-152x152.2752eea1.png> <link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon-180x180.039d6cab.png> <link rel=icon type=image/png href=/favicon-32x32.30180f81.png sizes=32x32> <link rel=icon type=image/png href=/favicon-194x194.1000be56.png sizes=194x194> <link rel=icon type=image/png href=/favicon-96x96.f2faacce.png sizes=96x96> <link rel=icon type=image/png href=/android-chrome-192x192.4cbd868f.png sizes=192x192> <link rel=icon type=image/png href=/favicon-16x16.a89c5d9c.png sizes=16x16> <link rel=manifest href=/manifest.1511a6ac.json> <link rel=mask-icon href=/safari-pinned-tab.e5d3bbf2.svg color=#ac4142> <meta name=msapplication-TileColor content=#ac4142> <meta name=msapplication-TileImage content=/mstile-144x144.0b30aa6d.png> <meta name=theme-color content=#ac4142>  <link rel=canonical href=https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor> <link itemprop="url mainEntityOfPage" href=https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor> <meta property=og:url content=https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor>      <link rel=stylesheet href=/css/app.ad2ca5d4.css> </head> <body> <aside class="sidebar container"> <header> <h1> <a rel=home href="/"> <svg class="icon icon-balance-scale" role=img> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-balance-scale"/> </svg><br> The Hermetic Vault </a> </h1> <p> typedef typename template </p> </header> <section> <h2> <svg class="icon icon-tags" role=img> <title>Site Tags</title> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-tags"/> </svg> </h2> <ul class=inline> <li> <a href=/tag/.net>.NET</a>&nbsp;‡ </li> <li> <a href=/tag/appveyor>AppVeyor</a>&nbsp;‡ </li> <li> <a href=/tag/boost>Boost</a>&nbsp;‡ </li> <li> <a href=/tag/c%2B%2B>C++</a>&nbsp;‡ </li> <li> <a href=/tag/ci>CI</a>&nbsp;‡ </li> <li> <a href=/tag/coverity>Coverity</a>&nbsp;‡ </li> <li> <a href=/tag/design-patterns>Design Patterns</a>&nbsp;‡ </li> <li> <a href=/tag/generic-programming>Generic Programming</a>&nbsp;‡ </li> <li> <a href=/tag/oop>OOP</a>&nbsp;‡ </li> <li> <a href=/tag/powershell>PowerShell</a>&nbsp;‡ </li> <li> <a href=/tag/static-analysis>Static Analysis</a>&nbsp;‡ </li> <li> <a href=/tag/windows-api>Windows API</a> </li> </ul> </section> <nav> <h2 class=visuallyhidden>Site Navigation</h2> <ul class=inline> <li> <a rel=home class="link-icon nav-icon" href=/ title=Home> <svg class="icon icon-home" role=img> <title>Home</title> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-home"/> </svg> </a> </li> <li> <a class="link-icon nav-icon" href=/archive title=Archive> <svg class="icon icon-list" role=img> <title>Archive</title> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-list"/> </svg> </a> </li> <li> <a rel="home alternate" class="link-icon nav-icon" href=/atom.xml title="News Feed"> <svg class="icon icon-feed" role=img> <title>News Feed</title> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-feed"/> </svg> </a> </li> <li> <a class="link-icon nav-icon" href=/contact title=Contact> <svg class="icon icon-question" role=img> <title>Contact</title> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-question"/> </svg> </a> </li> <li> <a rel=author class="link-icon nav-icon" href=/about title=About> <svg class="icon icon-info" role=img> <title>About</title> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-info"/> </svg> </a> </li> </ul> </nav> <hr> <footer> <ul class=inline> <li> <a href=/legal/disclaimer><small>Disclaimer</small></a> <small>‡</small> </li> <li> <a href=/legal/privacy-policy title="Privacy Policy"><small>Privacy</small></a> </li> </ul> <p> <small>© 2016 TheHermeticVault.com</small> </p> </footer> </aside> <main class="content container">  <div class=page-image itemprop=image itemscope itemtype=https://schema.org/ImageObject> <img src=/img/pages/codex-hammurabi.jpg alt="Codex Hammurabi, Louvre, Paris" itemprop="url contentUrl" width=1620 height=1080> <meta itemprop=width content=1620> <meta itemprop=height content=1080> <small> Codex Hammurabi, Louvre, Paris (Image by <a href=https://www.flickr.com/photos/batigolix/3332923984/in/photostream/ rel=external itemprop=author>Boris Doesborg</a>) </small> </div>  <article> <h1 itemprop=headline>Using Coverity Scan with AppVeyor</h1> <footer> <h2 class=visuallyhidden>Metadata</h2>  <dl class="inline grey"> <dt> <svg class="icon icon-clock-o" role=img> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-clock-o"/> </svg> Published: </dt> <dd> <time datetime=2015-01-07T00:00:00+03:00 itemprop=datePublished>07 Jan 2015</time>. </dd> <dt> <svg class="icon icon-newspaper-o" role=img> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-newspaper-o"/> </svg> Reading time: </dt> <dd> <time datetime=PT8M itemprop=timeRequired>8 minutes</time>. </dd> <dt class=new-line> <svg class="icon icon-tags" role=img> <title>Tags</title> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-tags"/> </svg> </dt> <dd> <ul class=inline> <li> <a rel=tag class=main-muted href=/tag/appveyor>AppVeyor</a>, </li> <li> <a rel=tag class=main-muted href=/tag/ci>CI</a>, </li> <li> <a rel=tag class=main-muted href=/tag/coverity>Coverity</a>, </li> <li> <a rel=tag class=main-muted href=/tag/.net>.NET</a>, </li> <li> <a rel=tag class=main-muted href=/tag/powershell>PowerShell</a>, </li> <li> <a rel=tag class=main-muted href=/tag/static-analysis>Static Analysis</a>. </li> </ul> </dd> </dl> <meta itemprop=wordCount content=2201> <meta itemprop="articleSection about" content="Software Development"> <meta itemprop=author content="Pavel Frolov"> <span itemprop=publisher itemscope itemtype=https://schema.org/Organization> <meta itemprop=name content="The Hermetic Vault"> <span itemprop=logo itemscope itemtype=https://schema.org/ImageObject> <link itemprop="url contentUrl" href=/img/pages/logo.png> <meta itemprop=width content=600> <meta itemprop=height content=60> </span> </span> <meta itemprop=dateModified content=2016-02-02T08:45:07+03:00> </footer> <div class=drop-letter itemprop=articleBody> <p>A<a rel=external href=http://www.appveyor.com>ppVeyor</a> is an awesome <abbr title="Software as a Service">SaaS</abbr><sup id=fnref:fn-saas><a href=#fn:fn-saas class=footnote>1</a></sup> <abbr title="Continuous Integration">CI</abbr><sup id=fnref:fn-ci><a href=#fn:fn-ci class=footnote>2</a></sup> server similar to <a rel=external href=https://travis-ci.org>Travis <abbr title="Continuous Integration">CI</abbr></a> but for Windows developers. It enables you to build, test and deploy all sorts of projects: C/C++, .NET, IIS, SQL Server, WiX, among others (see <a rel=external href=http://www.appveyor.com/docs/installed-software>Instaled Software</a>). Moreover, it is completely free for open source projects.</p> <p><a rel=external href=https://scan.coverity.com>Coverity Scan</a> is a free <abbr title="Software as a Service">SaaS</abbr> version of <a rel=external href=http://www.coverity.com>Coverity</a>, static code analysis solution for C/C++, C# and Java. Coverity Scan is used by some major Open Source projects such as Linux, Python, PostgreSQL, Apache Software Foundation projects.</p> <p>Unlike Travis <abbr title="Continuous Integration">CI</abbr>, AppVeyor currently lacks out of the box integration with Coverity Scan. In this article I’ll show you how to enable Coverity Scan code analysis for your project by injecting custom PowerShell scripts into AppVeyor build process.</p> <p><strong><em>The rest of the article assumes that you have a GitHub repository registered with both AppVeyor and Coverity Scan, and you are familiar with Coverity Scan workflow (i.e. manually building your project with Coverity Build Tool and submitting results to Coverity Scan server).</em></strong></p> <h2 id=the-necessary-steps>The Necessary Steps</h2> <p>Analysing project source code with Coverity Scan involves the following steps:</p> <ol> <li><a href=#downloading-coverity-build-tool>Download Coverity Build Tool</a>.</li> <li><a href=#building-project-with-coverity-build-tool>Build project with Coverity Build Tool</a>.</li> <li><a href=#compressing-scan-data>Compress scan data</a>.</li> <li><a href=#uploading-scan-data-to-coverity-scan-server>Upload scan data to Coverity Scan server</a>.</li> </ol> <h2 id=a-note-on-scan-data-submissions-frequency>A Note on Scan Data Submissions Frequency</h2> <p>One important thing to note when working with Coverity Scan is build submissions frequency. Coverity Scan <a rel=external href=https://scan.coverity.com/faq#frequency>limits maximum number of submitted builds</a> on daily and weekly basis. But even with limits left out of scope it is probably impractical to run each and every build with Coverity Scan since it takes noticeably longer time to complete. Let’s see how we can deal with it.</p> <h3 id=using-dedicated-branch>Using Dedicated Branch</h3> <p>Coverity Scan documentation suggests us to create a separate branch dedicated for code analysis (let’s call it <strong>analyse</strong>). In that case, we can conditionally enable Coverity Scan when building our project using <code class=highlighter-rouge>APPVEYOR_REPO_BRANCH</code> built‐in environment variable. Personally, I find this approach somewhat inconvenient: we need to keep our <strong>analyse</strong> branch in sync with <strong>develop</strong> branch (although this can be automated if necessary).</p> <h3 id=using-scheduled-builds>Using Scheduled Builds</h3> <p>Alternatively, we can use AppVeyor <a rel=external href=http://www.appveyor.com/docs/build-configuration#scheduled-builds>Scheduled Builds</a> feature to run Coverity Scan. For example, I use the following <a rel=external href=https://code.google.com/p/ncrontab/wiki/CrontabExpression>crontab</a> expression to launch Coverity build at 5:00 p.m. UTC+03 on Friday: <code class=highlighter-rouge>0 14 * * 5</code>. Also there is a handy built‐in variable named <code class=highlighter-rouge>APPVEYOR_SCHEDULED_BUILD</code> which is set to <code class=highlighter-rouge>True</code> when the build is a scheduled one. I find this approach more convenient, so I’ll stick to it for the rest of the article.</p> <h2 id=downloading-coverity-build-tool>Downloading Coverity Build Tool</h2> <p><ins>Coverity Build Tool now comes pre‐instaled on AppVeyor builder so this step is not necessary anymore. See the link in <a href=#comment-1878112356>comment by Mark Clearwater</a> for more information.</ins></p> <p>The first step may sound simple, but <em>one does not simply download Coverity Build Tool</em>. First, for security and legal reasons you need to pass your Coverity Scan project name and token as part of download request. Second, the download link is specific to you project language. See more on <a rel=external href=https://communities.coverity.com/message/6120#6120>Coverity Community discussion page</a>.</p> <p>We will use PowerShell, and the right place to put our script is <code class=highlighter-rouge>install</code> hook in <code class=highlighter-rouge>appveyor.yml</code>:</p> <figure class=highlight><pre><code class=language-yaml data-lang=yaml><span class=s>install</span><span class=pi>:</span>
<span class=pi>-</span> <span class=s>ps</span><span class=pi>:</span> <span class=pi>|</span>
    <span class=no># Here goes our code.</span></code></pre></figure> <p>Let’s deal with input data.</p> <p>The <strong>Project name</strong> is your Coverity Scan project name as seen in web UI. Usually it’s the same as GitHub project name (<code class=highlighter-rouge>owner-name/repo-name</code>), in which case you can use convinient <code class=highlighter-rouge>APPVEYOR_REPO_NAME</code> built‐in variable for it.</p> <p>The <strong>Project token</strong> is used by Coverity Scan for automated build submissions. You can examine and regenerate it in your Coverity Scan web GUI <strong>Project Settings</strong> page. The token is meant to be kept in secret, so it is a good practice to use AppVeyor <a rel=external href=http://www.appveyor.com/docs/build-configuration#secure-variables>Secure Variables</a> feature to encrypt it:</p> <figure class=highlight><pre><code class=language-yaml data-lang=yaml><span class=s>environment</span><span class=pi>:</span>
  <span class=s>CoverityProjectToken</span><span class=pi>:</span>
    <span class=s>secure</span><span class=pi>:</span> <span class=s>iNIJoA5yBGe4K1lV06g9Sta6kvcxeDxhnavNngxeEyE=</span></code></pre></figure> <p>The <strong>Download link</strong> can be obtained from your Coverity Scan web GUI <strong>Submit Build</strong> page. Choose link for <code class=highlighter-rouge>Win64</code> platform (AppVeyor build worker is 64‐bit Windows Server). In my case (the project language is <code class=highlighter-rouge>C++</code>), the download link is <code class=highlighter-rouge>https://scan.coverity.com/download/cxx/win_64</code>.</p> <p>Now we can craft the HTTP request with the help of <a rel=external href=https://technet.microsoft.com/en-us/library/hh849901.aspx>Invoke-WebRequest</a> cmdlet:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c1># Download Coverity Build Tool if we are doing scheduled build.</span>
<span class=k>if</span> <span class=o>(</span><span class=nv>$env</span>:APPVEYOR_SCHEDULED_BUILD -eq <span class=s2>"True"</span><span class=o>)</span> <span class=o>{</span>
  Invoke-WebRequest <span class=sb>`</span>
    -Uri <span class=s2>"https://scan.coverity.com/download/cxx/win_64"</span> <span class=sb>`</span>
    -Body @<span class=o>{</span> project <span class=o>=</span> <span class=s2>"</span><span class=nv>$env</span><span class=s2>:APPVEYOR_REPO_NAME"</span>;
             token <span class=o>=</span> <span class=s2>"</span><span class=nv>$env</span><span class=s2>:CoverityProjectToken"</span> <span class=o>}</span> <span class=sb>`</span>
    -OutFile <span class=s2>"</span><span class=nv>$env</span><span class=s2>:APPVEYOR_BUILD_FOLDER</span><span class=se>\c</span><span class=s2>overity.zip"</span>
  <span class=c1># Unzip downloaded package.</span>
  Add-Type -AssemblyName <span class=s2>"System.IO.Compression.FileSystem"</span>
  <span class=o>[</span>IO.Compression.ZipFile]::ExtractToDirectory<span class=o>(</span>
    <span class=s2>"</span><span class=nv>$env</span><span class=s2>:APPVEYOR_BUILD_FOLDER</span><span class=se>\c</span><span class=s2>overity.zip"</span>,
    <span class=s2>"</span><span class=nv>$env</span><span class=s2>:APPVEYOR_BUILD_FOLDER"</span><span class=o>)</span>
<span class=o>}</span></code></pre></figure> <h2 id=building-project-with-coverity-build-tool>Building Project with Coverity Build Tool</h2> <p>The next step is to build the project with Coverity Build Tool. This means passing your build command to <code class=highlighter-rouge>cov-build.exe</code>:</p> <figure class=highlight><pre><code class=language-batch data-lang=batch>cov-build.exe --dir cov-int &lt;build command&gt;</code></pre></figure> <p>Here <code class=highlighter-rouge>cov-int</code> is a name of directory to place collected scan data into.</p> <p>For example, if your build command is</p> <figure class=highlight><pre><code class=language-batch data-lang=batch>msbuild "/l:C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"</code></pre></figure> <p>Then, corresponding Coverity Build command becomes</p> <figure class=highlight><pre><code class=language-batch data-lang=batch>cov-build.exe --dir cov-int msbuild.exe ^
"/l:C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"</code></pre></figure> <p>For this to work we need to drop AppVeyor built‐in MSBuild support in favour of custom build script:</p> <figure class=highlight><pre><code class=language-yaml data-lang=yaml><span class=s>build_script</span><span class=pi>:</span>
<span class=pi>-</span> <span class=s>ps</span><span class=pi>:</span> <span class=pi>|</span>
    <span class=no># Here goes our code.</span></code></pre></figure> <p>The actual PowerShell code snippet:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c1># Define build command.</span>
<span class=nv>$buildCmd</span> <span class=o>=</span> <span class=s2>"C:</span><span class=se>\P</span><span class=s2>rogram Files (x86)</span><span class=se>\M</span><span class=s2>SBuild</span><span class=se>\1</span><span class=s2>2.0</span><span class=se>\b</span><span class=s2>in</span><span class=se>\m</span><span class=s2>sbuild.exe"</span>
<span class=nv>$buildArgs</span> <span class=o>=</span> @<span class=o>(</span>
  <span class=s2>"/m"</span>,
  <span class=s2>"/l:C:</span><span class=se>\P</span><span class=s2>rogram Files</span><span class=se>\A</span><span class=s2>ppVeyor</span><span class=se>\B</span><span class=s2>uildAgent</span><span class=se>\A</span><span class=s2>ppveyor.MSBuildLogger.dll"</span>,
  <span class=s2>"/p:Configuration=</span><span class=nv>$env</span><span class=s2>:CONFIGURATION"</span>,
  <span class=s2>"/p:Platform=</span><span class=nv>$env</span><span class=s2>:PLATFORM"</span><span class=o>)</span>

<span class=c1># If build is not a scheduled one, then simply build the project with MSBuild.</span>
<span class=k>if</span> <span class=o>(</span><span class=nv>$env</span>:APPVEYOR_SCHEDULED_BUILD -ne <span class=s2>"True"</span><span class=o>)</span> <span class=o>{</span>
  &amp; <span class=nv>$buildCmd</span> <span class=nv>$buildArgs</span>
  <span class=k>return</span>  <span class=c1># exit script</span>
<span class=o>}</span>

<span class=c1># Else, build project with Coverity Scan.</span>
<span class=s2>"Building project with Coverity Scan..."</span>
&amp; <span class=s2>".</span><span class=se>\c</span><span class=s2>ov-analysis-win64-7.6.0</span><span class=se>\b</span><span class=s2>in</span><span class=se>\c</span><span class=s2>ov-build.exe"</span> <span class=sb>`</span>
  --dir cov-int <span class=sb>`</span>
  <span class=nv>$buildCmd</span> <span class=nv>$buildArgs</span>

<span class=c1># Compress scan data.</span>
<span class=c1># ...</span>

<span class=c1># Upload scan data.</span>
<span class=c1># ...</span></code></pre></figure> <p>Things to note here:</p> <ul> <li>I’m using predefined <code class=highlighter-rouge>CONFIGURATION</code> and <code class=highlighter-rouge>PLATFORM</code> variables to simulate behaviour of AppVeyour buit-in MSBuild provider.</li> <li>The directory <code class=highlighter-rouge>cov-analysis-win64-7.6.0</code> is created by extracting Coverity Build Tool ZIP archive on the previous step.</li> <li>After building the project with Coverity Build Tool there will be directory named <code class=highlighter-rouge>cov-int</code> under <code class=highlighter-rouge>APPVEYOR_BUILD_FOLDER</code>.</li> </ul> <h2 id=compressing-scan-data>Compressing Scan Data</h2> <p>Coverity Scan requires the scan data collected during build to be compressed. We can easily do this with 7‐Zip which comes pre‐instaled on AppVeyor build worker. However, I’ll show you pure PowerShell/.NET way of doing this which involves some nasty .NET bug and one cool PowerShell trick to workaround it.</p> <p>Currently, the only way to create ZIP archive in PowerShell which is available out of the box (that I’m aware of) is to use .NET <a rel=external href="https://msdn.microsoft.com/en-us/library/system.io.compression.zipfile(v=vs.110).aspx">System.IO.Compression.ZipFile API</a>:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=o>[</span>IO.Compression.ZipFile]::CreateFromDirectory<span class=o>(</span>
  <span class=s2>"</span><span class=nv>$env</span><span class=s2>:APPVEYOR_BUILD_FOLDER</span><span class=se>\c</span><span class=s2>ov-int"</span>,
  <span class=s2>"</span><span class=nv>$env</span><span class=s2>:APPVEYOR_BUILD_FOLDER</span><span class=se>\$</span><span class=s2>env:APPVEYOR_PROJECT_NAME.zip"</span><span class=o>)</span></code></pre></figure> <p>Unfortunately, if you try to upload ZIP file created with <code class=highlighter-rouge>IO.Compression.ZipFile</code> the analysis will fail. The reason is a <a rel=external href=https://connect.microsoft.com/VisualStudio/feedback/details/862380/archive-created-with-system-io-compression-zipfile-createfromdirectory-does-not-preserve-directories-structure-when-unpacked-on-mac-os>bug</a> in <code class=highlighter-rouge>IO.Compression.ZipFile</code> implementation due to which file names inside ZIP archive are encoded with backslashes as path separators (according to <cite><a rel=external href=https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT>ZIP format specification</a> </cite> <q>all slashes MUST be forward slashes ‘/’ as opposed to backwards slashes ‘\’</q>). As a result, such an archive cannot be unpacked on *nix systems (Coverity Scan is using Ubuntu currently).</p> <p>To workaround the bug, we need to create custom encoder for ZIP file name entries, which means defining .NET class. Can we do this from PowerShell script? Yep, we can!</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c1># Compress results.</span>
<span class=s2>"Compressing Coverity results..."</span>
<span class=nv>$zipEncoderDef</span> <span class=o>=</span> @<span class=s1>'
  namespace AnalyseCode {
    public class PortableFileNameEncoder: System.Text.UTF8Encoding {
      public PortableFileNameEncoder() {}
      public override byte[] GetBytes(string entry) {
        return base.GetBytes(entry.Replace("\\", "/"));
      }
    }
  }
'</span>@
Add-Type -TypeDefinition <span class=nv>$zipEncoderDef</span>
<span class=o>[</span>IO.Compression.ZipFile]::CreateFromDirectory<span class=o>(</span>
  <span class=s2>"</span><span class=nv>$env</span><span class=s2>:APPVEYOR_BUILD_FOLDER</span><span class=se>\c</span><span class=s2>ov-int"</span>,
  <span class=s2>"</span><span class=nv>$env</span><span class=s2>:APPVEYOR_BUILD_FOLDER</span><span class=se>\$</span><span class=s2>env:APPVEYOR_PROJECT_NAME.zip"</span>,
  <span class=o>[</span>IO.Compression.CompressionLevel]::Optimal,
  <span class=nv>$true</span>,  <span class=c1># include root directory</span>
  <span class=o>(</span><span class=nb>New-Object </span>AnalyseCode.PortableFileNameEncoder<span class=o>))</span></code></pre></figure> <p>Things to note:</p> <ul> <li><code class=highlighter-rouge>Add-Type -TypeDefinition $zipEncoderDef</code> defines new C# class, a custom encoder which replaces back slashes with forward slashes. The object of this class is passed as last parameter to <code class=highlighter-rouge>CreateFromDirectory</code> method.</li> <li>The fourth parameter of <code class=highlighter-rouge>CreateFromDirectory</code> is <code class=highlighter-rouge>true</code> to indicate that <code class=highlighter-rouge>$env:APPVEYOR_BUILD_FOLDER\cov-int</code> directory must be included into archive as a root directory (otherwise, only content of <code class=highlighter-rouge>cov-int</code> is included). That is required by Coverity Scan.</li> <li>After compressing the scan data there will be file named <code class=highlighter-rouge>&lt;APPVEYOR_PROJECT_NAME&gt;.zip</code> under <code class=highlighter-rouge>APPVEYOR_BUILD_FOLDER</code>.</li> </ul> <h2 id=uploading-scan-data-to-coverity-scan-server>Uploading Scan Data to Coverity Scan Server</h2> <p>That last step is the most complex one. In order to upload scan data to Coverity Scan server we need to send multipart/form‐data<sup id=fnref:fn-multipart><a href=#fn:fn-multipart class=footnote>3</a></sup> HTML form containing archived scan data along with some build metadata (the process is documented in <strong>Upload a Project Build</strong> page of your Coverity Scan project web GUI). This can be accomplished in many ways, I’ll use [System.Net.Http.MultipartFormDataContent][url-dotnet-multipart-form‐data].</p> <p>First, we need to initialize <code class=highlighter-rouge>HttpClient</code> and <code class=highlighter-rouge>MultipartFormDataContent</code>:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c1># Upload results to Coverity server.</span>
<span class=s2>"Uploading Coverity results..."</span>
Add-Type -AssemblyName <span class=s2>"System.Net.Http"</span>
<span class=nv>$client</span> <span class=o>=</span> <span class=nb>New-Object </span>Net.Http.HttpClient
<span class=nv>$client</span>.Timeout <span class=o>=</span> <span class=o>[</span>TimeSpan]::FromMinutes<span class=o>(</span>20<span class=o>)</span>
<span class=nv>$form</span> <span class=o>=</span> <span class=nb>New-Object </span>Net.Http.MultipartFormDataContent</code></pre></figure> <p>Note that <code class=highlighter-rouge>$client.Timeout</code> value must be large enough for the form to upload, otherwise exception will be thrown while sending data.</p> <p>Next, we’ll fill form fields one by one. Those fields are <strong>token</strong>, <strong>email</strong>, <strong>file</strong>, <strong>version</strong> and <strong>description</strong>.</p> <h3 id=the-token-field>The Token Field</h3> <p>The <strong>token</strong> is our Coverity Scan project token we used before to download Coverity Build Tool.</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c1># Fill token field.</span>
<span class=o>[</span>Net.Http.HttpContent]<span class=nv>$formField</span> <span class=o>=</span>
  <span class=nb>New-Object </span>Net.Http.StringContent<span class=o>(</span><span class=nv>$env</span>:CoverityProjectToken<span class=o>)</span>
<span class=nv>$form</span>.Add<span class=o>(</span><span class=nv>$formField</span>, <span class=s2>"</span><span class=sb>`</span><span class=s2>"token</span><span class=sb>`</span><span class=s2>""</span><span class=o>)</span></code></pre></figure> <h3 id=the-email-field>The Email Field</h3> <p>The <strong>email</strong> is an email address to which Coverity Scan should send a notification about analysis results.</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c1># Fill email field.</span>
<span class=nv>$formField</span> <span class=o>=</span> <span class=nb>New-Object </span>Net.Http.StringContent<span class=o>(</span><span class=nv>$env</span>:CoverityNotificationEmail<span class=o>)</span>
<span class=nv>$form</span>.Add<span class=o>(</span><span class=nv>$formField</span>, <span class=s2>"</span><span class=sb>`</span><span class=s2>"email</span><span class=sb>`</span><span class=s2>""</span><span class=o>)</span></code></pre></figure> <p>I recommend you to secure your email:</p> <figure class=highlight><pre><code class=language-yaml data-lang=yaml><span class=s>environment</span><span class=pi>:</span>
  <span class=s>CoverityNotificationEmail</span><span class=pi>:</span>
    <span class=s>secure</span><span class=pi>:</span> <span class=s>+eYz1A/Z8lciYhPTNqd7KgfkqxmG1nS/lOJqFjmvRdg=</span></code></pre></figure> <h3 id=the-file-field>The File Field</h3> <p>The <strong>file</strong> is our zipped scan data produced earlier:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c1># Fill file field.</span>
<span class=nv>$fs</span> <span class=o>=</span> <span class=nb>New-Object </span>IO.FileStream<span class=o>(</span>
  <span class=s2>"</span><span class=nv>$env</span><span class=s2>:APPVEYOR_BUILD_FOLDER</span><span class=se>\$</span><span class=s2>env:APPVEYOR_PROJECT_NAME.zip"</span>,
  <span class=o>[</span>IO.FileMode]::Open,
  <span class=o>[</span>IO.FileAccess]::Read<span class=o>)</span>
<span class=nv>$formField</span> <span class=o>=</span> <span class=nb>New-Object </span>Net.Http.StreamContent<span class=o>(</span><span class=nv>$fs</span><span class=o>)</span>
<span class=nv>$form</span>.Add<span class=o>(</span><span class=nv>$formField</span>, <span class=s2>"</span><span class=sb>`</span><span class=s2>"file</span><span class=sb>`</span><span class=s2>""</span>, <span class=s2>"</span><span class=nv>$env</span><span class=s2>:APPVEYOR_PROJECT_NAME.zip"</span><span class=o>)</span></code></pre></figure> <h3 id=the-version-field>The Version Field</h3> <p>Your need to set this field to the version of your build:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c1># Fill version field.</span>
<span class=nv>$formField</span> <span class=o>=</span> <span class=nb>New-Object </span>Net.Http.StringContent<span class=o>(</span><span class=nv>$env</span>:APPVEYOR_BUILD_VERSION<span class=o>)</span>
<span class=nv>$form</span>.Add<span class=o>(</span><span class=nv>$formField</span>, <span class=s2>"</span><span class=sb>`</span><span class=s2>"version</span><span class=sb>`</span><span class=s2>""</span><span class=o>)</span></code></pre></figure> <h3 id=the-description-field>The Description Field</h3> <p>An arbitrary text describing your build:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c1># Fill description field.</span>
<span class=nv>$formField</span> <span class=o>=</span> <span class=nb>New-Object </span>Net.Http.StringContent<span class=o>(</span><span class=s2>"AppVeyor scheduled build."</span><span class=o>)</span>
<span class=nv>$form</span>.Add<span class=o>(</span><span class=nv>$formField</span>, <span class=s2>"</span><span class=sb>`</span><span class=s2>"description</span><span class=sb>`</span><span class=s2>""</span><span class=o>)</span></code></pre></figure> <p>Finally, we can submit the form:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c1># Submit form.</span>
<span class=nv>$url</span> <span class=o>=</span> <span class=s2>"https://scan.coverity.com/builds?project=</span><span class=nv>$env</span><span class=s2>:APPVEYOR_REPO_NAME"</span>
<span class=nv>$task</span> <span class=o>=</span> <span class=nv>$client</span>.PostAsync<span class=o>(</span><span class=nv>$url</span>, <span class=nv>$form</span><span class=o>)</span>
<span class=k>try</span> <span class=o>{</span>
  <span class=nv>$task</span>.Wait<span class=o>()</span>  <span class=c1># throws AggregateException on timeout</span>
<span class=o>}</span> <span class=k>catch</span> <span class=o>[</span>AggregateException] <span class=o>{</span>
  <span class=k>throw</span> <span class=nv>$_</span>.Exception.InnerException
<span class=o>}</span>
<span class=nv>$task</span>.Result
<span class=nv>$fs</span>.Close<span class=o>()</span></code></pre></figure> <p>Things to note:</p> <ul> <li>We need to pass the project name in <code class=highlighter-rouge>owner-name/repo-name</code> format in the query string.</li> <li>On timeout <code class=highlighter-rouge>$task.Wait()</code> will throw <code class=highlighter-rouge>System.AggregateException</code> containing nested <code class=highlighter-rouge>System.Threading.Tasks.TaskCanceledException</code>.</li> </ul> <h2 id=examining-the-results>Examining the Results</h2> <p>After uploading the scan data you can examine intermediate results in your Coverity Scan project web GUI, and the final results will be delivered to you by email. Then use <strong>View Defects</strong> button in Coverity Scan web GUI to start triaging discovered issues.</p> <p>Here is full <a rel=external href=https://github.com/arkfps/smart-splash/blob/34ab7d398c8b1c824779b92cdd7175e27575a88b/appveyor.yml>appveyor.yml</a> utilising the approach described in the article.</p> <hr> <div class=footnotes> <ol> <li id=fn:fn-saas> <p><a rel=external href=https://en.wikipedia.org/wiki/Software_as_a_service>Software as a Service</a>. <a href=#fnref:fn-saas class=reversefootnote>&#8617;</a></p> </li> <li id=fn:fn-ci> <p><a rel=external href=https://en.wikipedia.org/wiki/Continuous_integration>Continuous Integration</a>. <a href=#fnref:fn-ci class=reversefootnote>&#8617;</a></p> </li> <li id=fn:fn-multipart> <p>A multipart/form-data is used to express values submitted through a web form. Originally defined as part of HTML 4.0, it is most commonly used for submitting files via HTTP. Defined in <a rel=external href=https://tools.ietf.org/html/rfc2388>RFC 2388</a>. <a href=#fnref:fn-multipart class=reversefootnote>&#8617;</a></p> </li> </ol> </div> </div>  <aside> <h2 class=visuallyhidden>Share</h2> <ul class=inline> <li> <a rel=external class="link-icon content-icon" href="https://www.facebook.com/sharer/sharer.php?u=https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor" target=_blank title="Share on Facebook (opens new window)"> <svg class="icon icon-facebook-square" role=img> <title>Share on Facebook (opens new window)</title> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-facebook-square"/> </svg> </a> </li> <li> <a rel=external class="link-icon content-icon" href="https://twitter.com/share?url=https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor&amp;hashtags=AppVeyor,CI,Coverity,dotNET,PowerShell,StaticAnalysis" target=_blank title="Share on Twitter (opens new window)"> <svg class="icon icon-twitter-square" role=img> <title>Share on Twitter (opens new window)</title> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-twitter-square"/> </svg> </a> </li> <li> <a rel=external class="link-icon content-icon" href="https://www.reddit.com/submit?url=https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor&amp;title=Using%20Coverity%20Scan%20with%20AppVeyor" target=_blank title="Share on Reddit (opens new window)"> <svg class="icon icon-reddit-square" role=img> <title>Share on Reddit (opens new window)</title> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-reddit-square"/> </svg> </a> </li> <li> <a rel=external class="link-icon content-icon" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor" target=_blank title="Share on LinkedIn (opens new window)"> <svg class="icon icon-linkedin-square" role=img> <title>Share on LinkedIn (opens new window)</title> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-linkedin-square"/> </svg> </a> </li> <li> <a rel=external class="link-icon content-icon" href="https://plus.google.com/share?url=https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor" target=_blank title="Share on Google+ (opens new window)"> <svg class="icon icon-google-plus-square" role=img> <title>Share on Google+ (opens new window)</title> <use xlink:href="/svg/symbol-defs.f828a296.svg#icon-google-plus-square"/> </svg> </a> </li> </ul> </aside>  <aside> <h2 class=visuallyhidden>Comments</h2> <div id=disqus_thread></div> <script>var disqus_config=function(){this.page.url="https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor",this.page.identifier="using-coverity-scan-with-appveyor",this.page.title="Using Coverity Scan with AppVeyor"};!function(){var e=document,t=e.createElement("script");t.src="//arkfps.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel="nofollow external">comments powered by Disqus.</a></noscript> </aside> </article>  <script type=application/ld+json>{ "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/appveyor", "name": "AppVeyor" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor", "name": "Using Coverity Scan with AppVeyor" } } ] }</script><script type=application/ld+json>{ "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/ci", "name": "CI" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor", "name": "Using Coverity Scan with AppVeyor" } } ] }</script><script type=application/ld+json>{ "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/coverity", "name": "Coverity" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor", "name": "Using Coverity Scan with AppVeyor" } } ] }</script><script type=application/ld+json>{ "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/.net", "name": ".NET" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor", "name": "Using Coverity Scan with AppVeyor" } } ] }</script><script type=application/ld+json>{ "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/powershell", "name": "PowerShell" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor", "name": "Using Coverity Scan with AppVeyor" } } ] }</script><script type=application/ld+json>{ "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/static-analysis", "name": "Static Analysis" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor", "name": "Using Coverity Scan with AppVeyor" } } ] }</script></main><script src=/js/svgxuse.11656d77.js></script></body></html>