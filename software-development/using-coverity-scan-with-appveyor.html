<!DOCTYPE html> <html itemscope itemtype=https://schema.org/BlogPosting lang=en-GB prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#"> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport> <title>Using Coverity Scan with AppVeyor</title> <meta content="Using Coverity Scan with AppVeyor" itemprop=name> <meta content="Using Coverity Scan with AppVeyor" property=og:title> <meta content="Unlike Travis CI, AppVeyor currently lacks out of the box integration with Coverity Scan. In this article I’ll show you how to enable Coverity Scan code analysis for your project by injecting custom PowerShell scripts into AppVeyor build process." name=description> <meta content="Unlike Travis CI, AppVeyor currently lacks out of the box integration with Coverity Scan. In this article I’ll show you how to enable Coverity Scan code analysis for your project by injecting custom PowerShell scripts into AppVeyor build process." itemprop=description> <meta content="Unlike Travis CI, AppVeyor currently lacks out of the box integration with Coverity Scan. In this article I’ll show you how to enable Coverity Scan code analysis for your project by injecting custom PowerShell scripts into AppVeyor build process." property=og:description> <meta content="CI,.NET,PowerShell,Static Analysis" name=keywords> <meta content="CI,.NET,PowerShell,Static Analysis" itemprop=keywords> <meta content="Pavel Frolov" name=author> <meta content=https://thehermeticvault.com/img/pages/codex-hammurabi.jpg property=og:image> <meta content="Codex Hammurabi, Louvre, Paris" property=og:image:alt> <meta content=image/jpeg property=og:image:type> <meta content=1620 property=og:image:width> <meta content=1080 property=og:image:height> <meta content="Codex Hammurabi, Louvre, Paris" name=twitter:image:alt> <meta content="The Hermetic Vault" property=og:site_name> <meta content=article property=og:type> <meta content=en_GB property=og:locale> <meta content=2019-09-08T16:16:23+03:00 property=og:updated_time> <meta content=true property=og:rich_attachment> <meta content=416481208892021 property=fb:app_id> <meta content=100005735232020 property=fb:profile_id> <meta content=2015-01-07T00:00:00+03:00 property=article:published_time> <meta content=2019-09-08T16:16:23+03:00 property=article:modified_time> <meta content=https://www.facebook.com/100005735232020 property=article:author> <meta content="Software Development" property=article:section> <meta content=CI property=article:tag> <meta content=.NET property=article:tag> <meta content=PowerShell property=article:tag> <meta content="Static Analysis" property=article:tag> <meta content=summary_large_image name=twitter:card> <meta content=4133911523 name=twitter:site:id> <meta content=4133911523 name=twitter:creator:id> <link href=/apple-touch-icon.png rel=apple-touch-icon sizes=180x180> <link href=/favicon-32x32.png rel=icon sizes=32x32 type=image/png> <link href=/favicon-16x16.png rel=icon sizes=16x16 type=image/png> <link href=/manifest.38610ec1.json rel=manifest> <link href=/safari-pinned-tab.79875d88.svg rel=mask-icon color=#ac4142> <meta content=#404040 name=theme-color> <link href=https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor rel=canonical> <link href=https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor itemprop="url mainEntityOfPage"> <meta content=https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor property=og:url> <link href=https://use.typekit.net/bck7qbl.css rel=stylesheet> <link href=/css/app.499db767.css rel=stylesheet> </head> <body> <aside class="container sidebar"> <header> <h1> <a href=/ rel=home> <svg class="icon icon-balance-scale" role=img> <use xlink:href=/icn/symbol-defs.ebccfbad.svg#icon-balance-scale /> </svg><br> The Hermetic Vault </a> </h1> <p> typedef typename template </p> </header> <section> <h2> <svg class="icon icon-tags" role=img> <title>Site Tags</title> <use xlink:href=/icn/symbol-defs.ebccfbad.svg#icon-tags /> </svg> </h2> <ul class=inline> <li> <a href=/tag/.net>.NET</a> </li> <li>  <a href=/tag/boost>Boost</a> </li> <li>  <a href=/tag/c%2B%2B>C++</a> </li> <li>  <a href=/tag/ci>CI</a> </li> <li>  <a href=/tag/design-patterns>Design&nbsp;Patterns</a> </li> <li>  <a href=/tag/generic-programming>Generic&nbsp;Programming</a> </li> <li>  <a href=/tag/oop>OOP</a> </li> <li>  <a href=/tag/powershell>PowerShell</a> </li> <li>  <a href=/tag/static-analysis>Static&nbsp;Analysis</a> </li> <li>  <a href=/tag/windows-api>Windows&nbsp;API</a> </li> </ul> </section> <nav> <h2 class=screenreader-only>Site Navigation</h2> <ul class=inline> <li><a href=/ rel=home class="link-icon nav-icon" title=Home><svg class="icon icon-home" role=img><title>Home</title><use xlink:href=/icn/symbol-defs.ebccfbad.svg#icon-home /></svg></a></li> <li><a href=/archive class="link-icon nav-icon" title=Archive><svg class="icon icon-list" role=img><title>Archive</title><use xlink:href=/icn/symbol-defs.ebccfbad.svg#icon-list /></svg></a></li> <li><a href=/feed rel="home alternate" class="link-icon nav-icon" title="News Feed" type=application/atom+xml><svg class="icon icon-feed" role=img><title>News Feed</title><use xlink:href=/icn/symbol-defs.ebccfbad.svg#icon-feed /></svg></a></li> <li><a href=/contact class="link-icon nav-icon" title=Contact><svg class="icon icon-question" role=img><title>Contact</title><use xlink:href=/icn/symbol-defs.ebccfbad.svg#icon-question /></svg></a></li> <li><a href=/about rel=author class="link-icon nav-icon" title=About><svg class="icon icon-info" role=img><title>About</title><use xlink:href=/icn/symbol-defs.ebccfbad.svg#icon-info /></svg></a></li> </ul> </nav> <br> <footer aria-label="Legal Information"> <ul class=inline> <li> <a href=/legal/disclaimer><small>Disclaimer</small></a> <small>‡</small> </li> <li> <a href=/legal/privacy-policy title="Privacy Policy"><small>Privacy</small></a> </li> </ul> <p> <small>© 2019 TheHermeticVault.com</small> </p> </footer> </aside> <main class="container content" id=main> <div class=page-image itemprop=image itemscope itemtype=https://schema.org/ImageObject style=--aspect-ratio:1.5> <img alt="Codex Hammurabi, Louvre, Paris" itemprop="url contentUrl" src=/img/pages/codex-hammurabi.jpg> <meta content=1620 itemprop=width> <meta content=1080 itemprop=height> <small> Codex Hammurabi, Louvre, Paris<br>(Image by <a href=https://www.flickr.com/photos/batigolix/3332923984/in/photostream/ rel=external itemprop=author>Boris Doesborg</a>) </small> </div> <article> <h1 itemprop=headline>Using Coverity Scan with AppVeyor</h1> <header> <h2 class=screenreader-only>Metadata</h2> <dl class="inline grey"> <div> <dt> <svg class="icon icon-clock-o" role=img> <desc>A clock.</desc> <use xlink:href=/icn/symbol-defs.ebccfbad.svg#icon-clock-o /> </svg> Published: </dt> <dd> <time datetime=2015-01-07T00:00:00+03:00 itemprop=datePublished>07 Jan 2015</time>. </dd> </div> <div> <dt> <svg class="icon icon-newspaper-o" role=img> <desc>A newspaper.</desc> <use xlink:href=/icn/symbol-defs.ebccfbad.svg#icon-newspaper-o /> </svg> Reading time: </dt> <dd> <time datetime=PT5M itemprop=timeRequired>5 minutes</time>. </dd> </div> <div class="new-line wrap-text"> <dt> <svg class="icon icon-tags" role=img> <title>Tags</title> <use xlink:href=/icn/symbol-defs.ebccfbad.svg#icon-tags /> </svg> </dt> <dd> <ul class=inline> <li> <a href=/tag/ci rel=tag class=main-muted>CI</a>, </li> <li> <a href=/tag/.net rel=tag class=main-muted>.NET</a>, </li> <li> <a href=/tag/powershell rel=tag class=main-muted>PowerShell</a>, </li> <li> <a href=/tag/static-analysis rel=tag class=main-muted>Static Analysis</a>. </li> </ul> </dd> </div> </dl> <meta content=2459 itemprop=wordCount> <meta content="Software Development" itemprop="articleSection about"> <meta content="Pavel Frolov" itemprop=author> <span itemprop=publisher itemscope itemtype=https://schema.org/Organization> <meta content="The Hermetic Vault" itemprop=name> <span itemprop=logo itemscope itemtype=https://schema.org/ImageObject> <link href=/img/pages/logo.png itemprop="url contentUrl"> <meta content=600 itemprop=width> <meta content=60 itemprop=height> </span> </span> <meta content=2019-09-08T16:16:23+03:00 itemprop=dateModified> </header> <div class=drop-letter itemprop=articleBody> <p><strong><em>The information in this article is largely outdated.</em></strong></p> <p><a href=https://www.appveyor.com rel=external>AppVeyor</a> is an awesome SaaS<sup id=fnref:fn-saas><a href=#fn:fn-saas class=footnote>1</a></sup> CI<sup id=fnref:fn-ci><a href=#fn:fn-ci class=footnote>2</a></sup> server similar to <a href=https://travis-ci.org rel=external>Travis CI</a> but for Windows developers. It enables you to build, test and deploy all sorts of projects: C/C++, .NET, IIS, SQL Server, WiX, among others (see <a href=https://www.appveyor.com/docs/installed-software/ rel=external>Installed Software</a>). Moreover, it is completely free for open source projects.</p> <p><a href=https://scan.coverity.com rel=external>Coverity Scan</a> is a free SaaS version of <a href=https://www.coverity.com rel=external>Coverity</a>, static code analysis solution for C/C++, C# and Java. Coverity Scan is used by some major Open Source projects such as Linux, Python, PostgreSQL, Apache Software Foundation projects.</p> <p>Unlike Travis CI, AppVeyor currently lacks out of the box integration with Coverity Scan. In this article I’ll show you how to enable Coverity Scan code analysis for your project by injecting custom PowerShell scripts into AppVeyor build process.</p> <p><strong><em>The rest of the article assumes that you have a GitHub repository registered with both AppVeyor and Coverity Scan, and you are familiar with Coverity Scan workflow (i.e. manually building your project with Coverity Build Tool and submitting results to Coverity Scan server).</em></strong></p> <h2 id=necessary-steps>Necessary Steps</h2> <p>Analysing project source code with Coverity Scan involves the following steps:</p> <ol> <li><a href=#downloading-coverity-build-tool>Download Coverity Build Tool</a>.</li> <li><a href=#building-project-with-coverity-build-tool>Build project with Coverity Build Tool</a>.</li> <li><a href=#compressing-scan-data>Compress scan data</a>.</li> <li><a href=#uploading-scan-data-to-coverity-scan-server>Upload scan data to Coverity Scan server</a>.</li> </ol> <h2 id=a-note-on-scan-data-submissions-frequency>A Note on Scan Data Submissions Frequency</h2> <p>One important thing to note when working with Coverity Scan is build submissions frequency. Coverity Scan <a href=https://scan.coverity.com/faq#frequency rel=external>limits maximum number of submitted builds</a> on daily and weekly basis. But even with limits left out of scope it is probably impractical to run each and every build with Coverity Scan since it takes noticeably longer time to complete. Let’s see how we can deal with it.</p> <h3 id=using-dedicated-branch>Using Dedicated Branch</h3> <p>Coverity Scan documentation suggests us to create a separate branch dedicated for code analysis (let’s call it <em>analyse</em>). In that case, we can conditionally enable Coverity Scan when building our project using <code class=highlighter-rouge>APPVEYOR_REPO_BRANCH</code> built‐in environment variable. Personally, I find this approach somewhat inconvenient: we need to keep our <em>analyse</em> branch in sync with <em>develop</em> branch (although this can be automated if necessary).</p> <h3 id=using-scheduled-builds>Using Scheduled Builds</h3> <p>Alternatively, we can use AppVeyor <a href=https://www.appveyor.com/docs/build-configuration#scheduled-builds rel=external>Scheduled Builds</a> feature to run Coverity Scan. For example, I use the following <a href=https://github.com/atifaziz/NCrontab/wiki/Crontab-Expression rel=external>crontab</a> expression to launch Coverity build at 5:00 p.m. UTC+03 on Friday: <code class=highlighter-rouge>0 14 * * 5</code>. Also there is a handy built‐in variable named <code class=highlighter-rouge>APPVEYOR_SCHEDULED_BUILD</code> which is set to <code class=highlighter-rouge>True</code> when the build is a scheduled one. I find this approach more convenient, so I’ll stick to it for the rest of the article.</p> <h2 id=downloading-coverity-build-tool>Downloading Coverity Build Tool</h2> <p><ins>Coverity Build Tool now comes pre‐installed on AppVeyor builder so this step is not necessary anymore.</ins></p> <p>The first step may sound simple, but <em>one does not simply download Coverity Build Tool</em>. First, for security and legal reasons you need to pass your Coverity Scan project name and token as part of download request. Second, the download link is specific to you project language. See more on <a href=https://communities.coverity.com/message/6120#6120 rel=external>Coverity Community discussion page</a>.</p> <p>We will use PowerShell, and the right place to put our script is <code class=highlighter-rouge>install</code> hook in <code class=highlighter-rouge>appveyor.yml</code>:</p> <figure class=highlight><pre><code class=language-yaml data-lang=yaml><span class=na>install</span><span class=pi>:</span>
<span class=pi>-</span> <span class=na>ps</span><span class=pi>:</span> <span class=pi>|</span>
      <span class=s># Here goes our code.</span></code></pre></figure> <p>Let’s deal with input data.</p> <p>The <em>Project name</em> is your Coverity Scan project name as seen in web UI. Usually it’s the same as GitHub project name (<code class=highlighter-rouge>owner-name/repo-name</code>), in which case you can use convinient <code class=highlighter-rouge>APPVEYOR_REPO_NAME</code> built‐in variable for it.</p> <p>The <em>Project token</em> is used by Coverity Scan for automated build submissions. You can examine and regenerate it in your Coverity Scan web GUI <em>Project Settings</em> page. The token is meant to be kept in secret, so it is a good practice to use AppVeyor <a href=https://www.appveyor.com/docs/build-configuration#secure-variables rel=external>Secure Variables</a> feature to encrypt it:</p> <figure class=highlight><pre><code class=language-yaml data-lang=yaml><span class=na>environment</span><span class=pi>:</span>
    <span class=na>CoverityProjectToken</span><span class=pi>:</span>
        <span class=na>secure</span><span class=pi>:</span> <span class=s>iNIJoA5yBGe4K1lV06g9Sta6kvcxeDxhnavNngxeEyE=</span></code></pre></figure> <p>The <em>Download link</em> can be obtained from your Coverity Scan web GUI <em>Submit Build</em> page. Choose link for <code class=highlighter-rouge>Win64</code> platform (AppVeyor build worker is 64‐bit Windows Server). In my case (the project language is <code class=highlighter-rouge>C++</code>), the download link is <code class=highlighter-rouge>https://scan.coverity.com/download/cxx/win_64</code>.</p> <p>Now we can craft the HTTP request with the help of <a href=https://msdn.microsoft.com/powershell/reference/5.1/microsoft.powershell.utility/Invoke-WebRequest rel=external>Invoke-WebRequest</a> cmdlet:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c># Download Coverity Build Tool if we are doing scheduled build.</span><span class=w>
</span><span class=kr>if</span><span class=w> </span><span class=p>(</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_SCHEDULED_BUILD</span><span class=w> </span><span class=o>-eq</span><span class=w> </span><span class=s2>"True"</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
    </span><span class=nf>Invoke-WebRequest</span><span class=w> </span><span class=err>`</span><span class=w>
        </span><span class=nt>-Uri</span><span class=w> </span><span class=s2>"https://scan.coverity.com/download/cxx/win_64"</span><span class=w> </span><span class=err>`</span><span class=w>
        </span><span class=nt>-Body</span><span class=w> </span><span class=p>@{</span><span class=w>
            </span><span class=nx>project</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_REPO_NAME</span><span class=s2>"</span><span class=w>
            </span><span class=nx>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>CoverityProjectToken</span><span class=s2>"</span><span class=w>
        </span><span class=p>}</span><span class=w> </span><span class=err>`</span><span class=w>
    </span><span class=nt>-OutFile</span><span class=w> </span><span class=s2>"</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_BUILD_FOLDER</span><span class=s2>\coverity.zip"</span><span class=w>
    </span><span class=c># Unzip downloaded package.</span><span class=w>
    </span><span class=nf>Add-Type</span><span class=w> </span><span class=nt>-AssemblyName</span><span class=w> </span><span class=s2>"System.IO.Compression.FileSystem"</span><span class=w>
    </span><span class=p>[</span><span class=no>IO.Compression.</span><span class=kt>ZipFile</span><span class=p>]::</span><span class=nf>ExtractToDirectory</span><span class=p>(</span><span class=w>
        </span><span class=s2>"</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_BUILD_FOLDER</span><span class=s2>\coverity.zip"</span><span class=p>,</span><span class=w>
        </span><span class=s2>"</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_BUILD_FOLDER</span><span class=s2>"</span><span class=p>)</span><span class=w>
</span><span class=p>}</span></code></pre></figure> <h2 id=building-project-with-coverity-build-tool>Building Project with Coverity Build Tool</h2> <p>The next step is to build the project with Coverity Build Tool. This means passing your build command to <code class=highlighter-rouge>cov-build.exe</code>:</p> <figure class=highlight><pre><code class=language-batchfile data-lang=batchfile><span class=kd>cov</span><span class=na>-build</span>.exe <span class=o>-</span><span class=na>-dir </span><span class=kd>cov</span><span class=na>-int </span><span class=o>&lt;</span><span class=kd>build</span> <span class=kd>command</span><span class=o>&gt;</span></code></pre></figure> <p>Here <code class=highlighter-rouge>cov-int</code> is a name of directory to place collected scan data into.</p> <p>For example, if your build command is</p> <figure class=highlight><pre><code class=language-batchfile data-lang=batchfile><span class=kd>msbuild</span> <span class=s2>"/l:C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"</span></code></pre></figure> <p>Then, corresponding Coverity Build command becomes</p> <figure class=highlight><pre><code class=language-batchfile data-lang=batchfile><span class=kd>cov</span><span class=na>-build</span>.exe <span class=o>-</span><span class=na>-dir </span><span class=kd>cov</span><span class=na>-int </span><span class=kd>msbuild</span><span class=err>.exe</span> <span class=se>^
</span><span class=s2>"/l:C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"</span></code></pre></figure> <p>For this to work we need to drop AppVeyor built‐in MSBuild support in favour of custom build script:</p> <figure class=highlight><pre><code class=language-yaml data-lang=yaml><span class=na>build_script</span><span class=pi>:</span>
<span class=pi>-</span> <span class=na>ps</span><span class=pi>:</span> <span class=pi>|</span>
      <span class=s># Here goes our code.</span></code></pre></figure> <p>The actual PowerShell code snippet:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c># Define build command.</span><span class=w>
</span><span class=nv>$buildCmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"C:\Program Files (x86)\MSBuild\12.0\bin\msbuild.exe"</span><span class=w>
</span><span class=nv>$buildArgs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>@(</span><span class=w>
    </span><span class=s2>"/m"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"/l:C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"/p:Configuration=</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>CONFIGURATION</span><span class=s2>"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"/p:Platform=</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>PLATFORM</span><span class=s2>"</span><span class=p>)</span><span class=w>

</span><span class=c># If build is not a scheduled one, then simply build the project with MSBuild.</span><span class=w>
</span><span class=kr>if</span><span class=w> </span><span class=p>(</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_SCHEDULED_BUILD</span><span class=w> </span><span class=o>-ne</span><span class=w> </span><span class=s2>"True"</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
    </span><span class=o>&amp;</span><span class=w> </span><span class=nv>$buildCmd</span><span class=w> </span><span class=nv>$buildArgs</span><span class=w>
    </span><span class=kr>return</span><span class=w>  </span><span class=c># exit script</span><span class=w>
</span><span class=p>}</span><span class=w>

</span><span class=c># Else, build project with Coverity Scan.</span><span class=w>
</span><span class=s2>"Building project with Coverity Scan..."</span><span class=w>
</span><span class=o>&amp;</span><span class=w> </span><span class=s2>".\cov-analysis-win64-7.6.0\bin\cov-build.exe"</span><span class=w> </span><span class=err>`</span><span class=w>
    </span><span class=nt>--dir</span><span class=w> </span><span class=nf>cov-int</span><span class=w> </span><span class=err>`</span><span class=w>
    </span><span class=nv>$buildCmd</span><span class=w> </span><span class=nv>$buildArgs</span><span class=w>

</span><span class=c># Compress scan data.</span><span class=w>
</span><span class=c># ...</span><span class=w>

</span><span class=c># Upload scan data.</span><span class=w>
</span><span class=c># ...</span></code></pre></figure> <p>Things to note here:</p> <ul> <li>I’m using predefined <code class=highlighter-rouge>CONFIGURATION</code> and <code class=highlighter-rouge>PLATFORM</code> variables to simulate behaviour of AppVeyour buit-in MSBuild provider.</li> <li>The directory <code class=highlighter-rouge>cov-analysis-win64-7.6.0</code> is created by extracting Coverity Build Tool ZIP archive on the previous step.</li> <li>After building the project with Coverity Build Tool there will be directory named <code class=highlighter-rouge>cov-int</code> under <code class=highlighter-rouge>APPVEYOR_BUILD_FOLDER</code>.</li> </ul> <h2 id=compressing-scan-data>Compressing Scan Data</h2> <p>Coverity Scan requires the scan data collected during build to be compressed. We can easily do this with 7‐Zip which comes pre‐installed on AppVeyor build worker. However, I’ll demonstrate you pure PowerShell/.NET way of doing this which involves some nasty .NET bug and one cool PowerShell trick to workaround it.</p> <p>Currently, the only way to create ZIP archive in PowerShell which is available out of the box (that I’m aware of) is to use .NET <a href="https://msdn.microsoft.com/en-us/library/system.io.compression.zipfile(v=vs.110).aspx" rel=external>System.IO.Compression.ZipFile API</a>:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=p>[</span><span class=no>IO.Compression.</span><span class=kt>ZipFile</span><span class=p>]::</span><span class=nf>CreateFromDirectory</span><span class=p>(</span><span class=w>
    </span><span class=s2>"</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_BUILD_FOLDER</span><span class=s2>\cov-int"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_BUILD_FOLDER</span><span class=s2>\</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_PROJECT_NAME</span><span class=s2>.zip"</span><span class=p>)</span></code></pre></figure> <p>Unfortunately, if you try to upload ZIP file created with <code class=highlighter-rouge>IO.Compression.ZipFile</code> the analysis will fail. The reason is a <a href=https://connect.microsoft.com/VisualStudio/feedback/details/862380/archive-created-with-system-io-compression-zipfile-createfromdirectory-does-not-preserve-directories-structure-when-unpacked-on-mac-os rel=external>bug</a> in <code class=highlighter-rouge>IO.Compression.ZipFile</code> implementation due to which file names inside ZIP archive are encoded with backslashes as path separators (according to <cite><a href=https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT rel=external>ZIP format specification</a> </cite> <q>all slashes MUST be forward slashes “/” as opposed to backwards slashes “\” </q>). As a result, such an archive cannot be unpacked on <em>*nix</em> systems (Coverity Scan is using Ubuntu currently).</p> <p>To workaround the bug, we need to create custom encoder for ZIP file name entries, which means defining .NET class. Can we do this from PowerShell script? Yep, we can!</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c># Compress results.</span><span class=w>
</span><span class=s2>"Compressing Coverity results..."</span><span class=w>
</span><span class=nv>$zipEncoderDef</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sh>@'
    namespace AnalyseCode {
        public class PortableFileNameEncoder: System.Text.UTF8Encoding {
            public PortableFileNameEncoder() {}
            public override byte[] GetBytes(string entry) {
                return base.GetBytes(entry.Replace("\\", "/"));
            }
        }
    }
'@</span><span class=w>
</span><span class=nf>Add-Type</span><span class=w> </span><span class=nt>-TypeDefinition</span><span class=w> </span><span class=nv>$zipEncoderDef</span><span class=w>
</span><span class=p>[</span><span class=no>IO.Compression.</span><span class=kt>ZipFile</span><span class=p>]::</span><span class=nf>CreateFromDirectory</span><span class=p>(</span><span class=w>
    </span><span class=s2>"</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_BUILD_FOLDER</span><span class=s2>\cov-int"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_BUILD_FOLDER</span><span class=s2>\</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_PROJECT_NAME</span><span class=s2>.zip"</span><span class=p>,</span><span class=w>
    </span><span class=p>[</span><span class=no>IO.Compression.</span><span class=kt>CompressionLevel</span><span class=p>]::</span><span class=nf>Optimal</span><span class=p>,</span><span class=w>
    </span><span class=bp>$true</span><span class=p>,</span><span class=w>  </span><span class=c># include root directory</span><span class=w>
    </span><span class=p>(</span><span class=nf>New-Object</span><span class=w> </span><span class=nx>AnalyseCode.PortableFileNameEncoder</span><span class=p>))</span></code></pre></figure> <p>Things to note:</p> <ul> <li><code class=highlighter-rouge>Add-Type -TypeDefinition $zipEncoderDef</code> defines new C# class, a custom encoder which replaces back slashes with forward slashes. The object of this class is passed as last parameter to <code class=highlighter-rouge>CreateFromDirectory</code> method.</li> <li>The fourth parameter of <code class=highlighter-rouge>CreateFromDirectory</code> is <code class=highlighter-rouge>true</code> to indicate that <code class=highlighter-rouge>$env:APPVEYOR_BUILD_FOLDER\cov-int</code> directory must be included into archive as a root directory (otherwise, only content of <code class=highlighter-rouge>cov-int</code> is included). That is required by Coverity Scan.</li> <li>After compressing the scan data there will be file named <code class=highlighter-rouge>&lt;APPVEYOR_PROJECT_NAME&gt;.zip</code> under <code class=highlighter-rouge>APPVEYOR_BUILD_FOLDER</code>.</li> </ul> <h2 id=uploading-scan-data-to-coverity-scan-server>Uploading Scan Data to Coverity Scan Server</h2> <p>That last step is the most complex one. In order to upload scan data to Coverity Scan server we need to send multipart/form‐data<sup id=fnref:fn-multipart><a href=#fn:fn-multipart class=footnote>3</a></sup> HTML form containing archived scan data along with some build metadata (the process is documented in <em>Upload a Project Build</em> page of your Coverity Scan project web GUI). This can be accomplished in many ways, I’ll use <code class=highlighter-rouge>System.Net.Http.MultipartFormDataContent</code>.</p> <p>First, we need to initialize <code class=highlighter-rouge>HttpClient</code> and <code class=highlighter-rouge>MultipartFormDataContent</code>:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c># Upload results to Coverity server.</span><span class=w>
</span><span class=s2>"Uploading Coverity results..."</span><span class=w>
</span><span class=nf>Add-Type</span><span class=w> </span><span class=nt>-AssemblyName</span><span class=w> </span><span class=s2>"System.Net.Http"</span><span class=w>
</span><span class=nv>$client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>New-Object</span><span class=w> </span><span class=nx>Net.Http.HttpClient</span><span class=w>
</span><span class=nv>$client</span><span class=o>.</span><span class=nf>Timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=kt>TimeSpan</span><span class=p>]::</span><span class=nf>FromMinutes</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=w>
</span><span class=nv>$form</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>New-Object</span><span class=w> </span><span class=nx>Net.Http.MultipartFormDataContent</span></code></pre></figure> <p>Note that <code class=highlighter-rouge>$client.Timeout</code> value must be large enough for the form to upload, otherwise exception will be thrown while sending data.</p> <p>Next, we’ll fill form fields one by one. Those fields are <em>token</em>, <em>email</em>, <em>file</em>, <em>version</em> and <em>description</em>.</p> <h3 id=token-field>Token Field</h3> <p>The <em>token</em> is our Coverity Scan project token we used before to download Coverity Build Tool.</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c># Fill token field.</span><span class=w>
</span><span class=p>[</span><span class=no>Net.Http.</span><span class=kt>HttpContent</span><span class=p>]</span><span class=nv>$formField</span><span class=w> </span><span class=o>=</span><span class=w>
    </span><span class=nf>New-Object</span><span class=w> </span><span class=nx>Net.Http.StringContent</span><span class=p>(</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>CoverityProjectToken</span><span class=p>)</span><span class=w>
</span><span class=nv>$form</span><span class=o>.</span><span class=nf>Add</span><span class=p>(</span><span class=nv>$formField</span><span class=p>,</span><span class=w> </span><span class=s1>'"token"'</span><span class=p>)</span></code></pre></figure> <h3 id=email-field>Email Field</h3> <p>The <em>email</em> is an email address to which Coverity Scan should send a notification about analysis results.</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c># Fill email field.</span><span class=w>
</span><span class=nv>$formField</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>New-Object</span><span class=w> </span><span class=nx>Net.Http.StringContent</span><span class=p>(</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>CoverityNotificationEmail</span><span class=p>)</span><span class=w>
</span><span class=nv>$form</span><span class=o>.</span><span class=nf>Add</span><span class=p>(</span><span class=nv>$formField</span><span class=p>,</span><span class=w> </span><span class=s1>'"email"'</span><span class=p>)</span></code></pre></figure> <p>I recommend you to secure your email:</p> <figure class=highlight><pre><code class=language-yaml data-lang=yaml><span class=na>environment</span><span class=pi>:</span>
    <span class=na>CoverityNotificationEmail</span><span class=pi>:</span>
        <span class=na>secure</span><span class=pi>:</span> <span class=s>+eYz1A/Z8lciYhPTNqd7KgfkqxmG1nS/lOJqFjmvRdg=</span></code></pre></figure> <h3 id=file-field>File Field</h3> <p>The <em>file</em> is our zipped scan data produced earlier:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c># Fill file field.</span><span class=w>
</span><span class=nv>$fs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>New-Object</span><span class=w> </span><span class=nx>IO.FileStream</span><span class=p>(</span><span class=w>
    </span><span class=s2>"</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_BUILD_FOLDER</span><span class=s2>\</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_PROJECT_NAME</span><span class=s2>.zip"</span><span class=p>,</span><span class=w>
    </span><span class=p>[</span><span class=no>IO.</span><span class=kt>FileMode</span><span class=p>]::</span><span class=nf>Open</span><span class=p>,</span><span class=w>
    </span><span class=p>[</span><span class=no>IO.</span><span class=kt>FileAccess</span><span class=p>]::</span><span class=nf>Read</span><span class=p>)</span><span class=w>
</span><span class=nv>$formField</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>New-Object</span><span class=w> </span><span class=nx>Net.Http.StreamContent</span><span class=p>(</span><span class=nv>$fs</span><span class=p>)</span><span class=w>
</span><span class=nv>$form</span><span class=o>.</span><span class=nf>Add</span><span class=p>(</span><span class=nv>$formField</span><span class=p>,</span><span class=w> </span><span class=s1>'"file"'</span><span class=p>,</span><span class=w> </span><span class=s2>"</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_PROJECT_NAME</span><span class=s2>.zip"</span><span class=p>)</span></code></pre></figure> <h3 id=version-field>Version Field</h3> <p>Your need to set this field to the version of your build:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c># Fill version field.</span><span class=w>
</span><span class=nv>$formField</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>New-Object</span><span class=w> </span><span class=nx>Net.Http.StringContent</span><span class=p>(</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_BUILD_VERSION</span><span class=p>)</span><span class=w>
</span><span class=nv>$form</span><span class=o>.</span><span class=nf>Add</span><span class=p>(</span><span class=nv>$formField</span><span class=p>,</span><span class=w> </span><span class=s1>'"version"'</span><span class=p>)</span></code></pre></figure> <h3 id=description-field>Description Field</h3> <p>An arbitrary text describing your build:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c># Fill description field.</span><span class=w>
</span><span class=nv>$formField</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>New-Object</span><span class=w> </span><span class=nx>Net.Http.StringContent</span><span class=p>(</span><span class=s2>"AppVeyor scheduled build."</span><span class=p>)</span><span class=w>
</span><span class=nv>$form</span><span class=o>.</span><span class=nf>Add</span><span class=p>(</span><span class=nv>$formField</span><span class=p>,</span><span class=w> </span><span class=s1>'"description"'</span><span class=p>)</span></code></pre></figure> <p>Finally, we can submit the form:</p> <figure class=highlight><pre><code class=language-powershell data-lang=powershell><span class=c># Submit form.</span><span class=w>
</span><span class=nv>$url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>"https://scan.coverity.com/builds?project=</span><span class=nv>$</span><span class=nn>env</span><span class=p>:</span><span class=nv>APPVEYOR_REPO_NAME</span><span class=s2>"</span><span class=w>
</span><span class=nv>$task</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nv>$client</span><span class=o>.</span><span class=nf>PostAsync</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span><span class=w> </span><span class=nv>$form</span><span class=p>)</span><span class=w>
</span><span class=kr>try</span><span class=w> </span><span class=p>{</span><span class=w>
    </span><span class=nv>$task</span><span class=o>.</span><span class=nf>Wait</span><span class=p>()</span><span class=w>  </span><span class=c># throws AggregateException on timeout</span><span class=w>
</span><span class=p>}</span><span class=w> </span><span class=kr>catch</span><span class=w> </span><span class=p>[</span><span class=kt>AggregateException</span><span class=p>]</span><span class=w> </span><span class=p>{</span><span class=w>
    </span><span class=kr>throw</span><span class=w> </span><span class=bp>$_</span><span class=o>.</span><span class=nf>Exception</span><span class=o>.</span><span class=nf>InnerException</span><span class=w>
</span><span class=p>}</span><span class=w>
</span><span class=nv>$task</span><span class=o>.</span><span class=nf>Result</span><span class=w>
</span><span class=nv>$fs</span><span class=o>.</span><span class=nf>Close</span><span class=p>()</span></code></pre></figure> <p>Things to note:</p> <ul> <li>We need to pass the project name in <code class=highlighter-rouge>owner-name/repo-name</code> format in the query string.</li> <li>On timeout <code class=highlighter-rouge>$task.Wait()</code> will throw <code class=highlighter-rouge>System.AggregateException</code> containing nested <code class=highlighter-rouge>System.Threading.Tasks.TaskCanceledException</code>.</li> </ul> <h2 id=examining-the-results>Examining the Results</h2> <p>After uploading the scan data you can examine intermediate results in your Coverity Scan project web GUI, and the final results will be delivered to you by email. Then use <em>View Defects</em> button in Coverity Scan web GUI to start triaging discovered issues.</p> <hr> <h2 id=footnotes class=screenreader-only>Footnotes</h2> <div class=footnotes> <ol> <li id=fn:fn-saas> <p><a href=https://en.wikipedia.org/wiki/Software_as_a_service rel=external>Software as a Service</a>. <a href=#fnref:fn-saas class=reversefootnote>↑</a></p> </li> <li id=fn:fn-ci> <p><a href=https://en.wikipedia.org/wiki/Continuous_integration rel=external>Continuous Integration</a>. <a href=#fnref:fn-ci class=reversefootnote>↑</a></p> </li> <li id=fn:fn-multipart> <p>A multipart/form-data is used to express values submitted through a web form. Originally defined as part of HTML 4.0, it is most commonly used for submitting files via HTTP. Defined in <a href=https://tools.ietf.org/html/rfc2388 rel=external>RFC 2388</a>. <a href=#fnref:fn-multipart class=reversefootnote>↑</a></p> </li> </ol> </div> </div> <aside> <h2 class=screenreader-only>Comments</h2> <div id=disqus_thread></div> <script>var disqus_config=function(){this.page.url="https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor",this.page.identifier="using-coverity-scan-with-appveyor",this.page.title="Using Coverity Scan with AppVeyor"};!function(){var t=document,e=t.createElement('script');e.src='https://arkfps.disqus.com/embed.js',e.setAttribute('data-timestamp',+new Date),(t.head||t.body).appendChild(e)}()</script> <noscript><i>Please enable JavaScript to view the comments.</i></noscript> </aside> </article> <script type=application/ld+json> { "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/ci", "name": "CI" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor", "name": "Using Coverity Scan with AppVeyor" } } ] } </script> <script type=application/ld+json> { "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/.net", "name": ".NET" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor", "name": "Using Coverity Scan with AppVeyor" } } ] } </script> <script type=application/ld+json> { "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/powershell", "name": "PowerShell" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor", "name": "Using Coverity Scan with AppVeyor" } } ] } </script> <script type=application/ld+json> { "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/static-analysis", "name": "Static Analysis" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/using-coverity-scan-with-appveyor", "name": "Using Coverity Scan with AppVeyor" } } ] } </script> </main> <script> window.onpageshow = (evt) => {
        'use strict';
        // Scroll view to main content area of page if not coming from history.
        if (window.location.hash) return;  // ignore URLs with fragment
        const nav = performance.getEntriesByType('navigation');
        if (nav.length) {  // for Chrome/Opera, Firefox, Edge
          if (nav[0].type === 'back_forward') return;
        } else if (evt.persisted) { // for Safari
          return;
        }
        const main = document.getElementById('main');
        if (main.scrollIntoView) main.scrollIntoView({ behavior: 'smooth' });
      }; </script> </body> </html> 