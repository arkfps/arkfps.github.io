<!doctype html> <html itemscope itemtype=https://schema.org/BlogPosting lang=en-GB prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#"> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport> <title>Making Boost.Signals2 More OOP‐Friendly</title> <meta content="Making Boost.Signals2 More OOP‐Friendly" itemprop=name> <meta content="Making Boost.Signals2 More OOP‐Friendly" property=og:title> <meta content="Unfortunately, unlike other mainstream languages, the C++ standard library doesn’t provide out of the box observer implementation. This article suggests an observable mixin based on Boost.Signals2 which makes it easy to build an observer." name=description> <meta content="Unfortunately, unlike other mainstream languages, the C++ standard library doesn’t provide out of the box observer implementation. This article suggests an observable mixin based on Boost.Signals2 which makes it easy to build an observer." itemprop=description> <meta content="Unfortunately, unlike other mainstream languages, the C++ standard library doesn’t provide out of the box observer implementation. This article suggests an observable mixin based on Boost.Signals2 which makes it easy to build an observer." property=og:description> <meta content="Boost,C++,Design Patterns,Generic Programming,OOP" name=keywords> <meta content="Boost,C++,Design Patterns,Generic Programming,OOP" itemprop=keywords> <meta content="Pavel Frolov" name=author> <meta content=https://thehermeticvault.com/img/pages/el-caracol-observatory.jpg property=og:image> <meta content="El Caracol observatory temple, Chichen Itza, Mexico" property=og:image:alt> <meta content=image/jpeg property=og:image:type> <meta content=1920 property=og:image:width> <meta content=936 property=og:image:height> <meta content="El Caracol observatory temple, Chichen Itza, Mexico" name=twitter:image:alt> <meta content="The Hermetic Vault" property=og:site_name> <meta content=article property=og:type> <meta content=en_GB property=og:locale> <meta content=2019-10-19T21:09:00+03:00 property=og:updated_time> <meta content=true property=og:rich_attachment> <meta content=416481208892021 property=fb:app_id> <meta content=100005735232020 property=fb:profile_id> <meta content=2015-04-17T00:00:00+03:00 property=article:published_time> <meta content=2019-10-19T21:09:00+03:00 property=article:modified_time> <meta content=https://www.facebook.com/100005735232020 property=article:author> <meta content="Software Development" property=article:section> <meta content=Boost property=article:tag> <meta content=C++ property=article:tag> <meta content="Design Patterns" property=article:tag> <meta content="Generic Programming" property=article:tag> <meta content=OOP property=article:tag> <meta content=summary_large_image name=twitter:card> <meta content=4133911523 name=twitter:site:id> <meta content=4133911523 name=twitter:creator:id> <link href=/apple-touch-icon.png rel=apple-touch-icon sizes=180x180> <link href=/favicon-32x32.png rel=icon sizes=32x32 type=image/png> <link href=/favicon-16x16.png rel=icon sizes=16x16 type=image/png> <link href=/manifest.9a62a12f.json rel=manifest> <link href=/safari-pinned-tab.157db8f0.svg rel=mask-icon color=#404040> <meta content=#404040 name=theme-color> <link href=https://thehermeticvault.com/software-development/making-boost-signals2-more-oop-friendly rel=canonical> <link href=https://thehermeticvault.com/software-development/making-boost-signals2-more-oop-friendly itemprop="url mainEntityOfPage"> <meta content=https://thehermeticvault.com/software-development/making-boost-signals2-more-oop-friendly property=og:url> <link href=https://use.typekit.net/bck7qbl.css rel=stylesheet> <link href=/css/app.72093cd7.css rel=stylesheet> </head> <body> <aside id=site-header> <div> <header> <h1 class=site-title> <a href=/ rel=home><svg class="icon icon-balance-scale" role=img><use xlink:href=/icn/symbol-defs.ed79ff9f.svg#icon-balance-scale /></svg><br>The Hermetic Vault</a> </h1> <p> typedef typename template </p> </header> <section class=site-tags> <h2 class=site-tags-title> <svg class="icon icon-tags" role=img> <title>Site Tags</title> <use xlink:href=/icn/symbol-defs.ed79ff9f.svg#icon-tags /> </svg> </h2> <ul class=inline> <li class=site-tag> <a href=/tag/.net>.NET</a> </li> <li class=site-tag> <a href=/tag/boost>Boost</a> </li> <li class=site-tag> <a href=/tag/c%2B%2B>C++</a> </li> <li class=site-tag> <a href=/tag/ci>CI</a> </li> <li class=site-tag> <a href=/tag/design-patterns>Design Patterns</a> </li> <li class=site-tag> <a href=/tag/generic-programming>Generic Programming</a> </li> <li class=site-tag> <a href=/tag/oop>OOP</a> </li> <li class=site-tag> <a href=/tag/powershell>PowerShell</a> </li> <li class=site-tag> <a href=/tag/static-analysis>Static Analysis</a> </li> <li class=site-tag> <a href=/tag/windows-api>Windows API</a> </li> </ul> </section> <nav class=site-nav> <h2 class=screenreader-only>Site Navigation</h2> <ul class=inline> <li><a href=/ class="link-icon nav-icon" rel=home title=Home><svg class="icon icon-home" role=img><title>Home</title><use xlink:href=/icn/symbol-defs.ed79ff9f.svg#icon-home /></svg></a></li> <li><a href=/archive class="link-icon nav-icon" title=Archive><svg class="icon icon-list" role=img><title>Archive</title><use xlink:href=/icn/symbol-defs.ed79ff9f.svg#icon-list /></svg></a></li> <li><a href=/feed class="link-icon nav-icon" rel="home alternate" title="News Feed" type=application/atom+xml><svg class="icon icon-feed" role=img><title>News Feed</title><use xlink:href=/icn/symbol-defs.ed79ff9f.svg#icon-feed /></svg></a></li> <li><a href=/contact class="link-icon nav-icon" title=Contact><svg class="icon icon-question" role=img><title>Contact</title><use xlink:href=/icn/symbol-defs.ed79ff9f.svg#icon-question /></svg></a></li> <li><a href=/about class="link-icon nav-icon" rel=author title=About><svg class="icon icon-info" role=img><title>About</title><use xlink:href=/icn/symbol-defs.ed79ff9f.svg#icon-info /></svg></a></li> </ul> </nav> <footer class=site-legal> <h2 class=screenreader-only>Legal Information</h2> <ul class=inline> <li> <a href=/legal/disclaimer><small>Disclaimer</small></a> <small>‡</small> </li> <li> <a href=/legal/privacy-policy title="Privacy Policy"><small>Privacy</small></a> </li> </ul> <p> <small>© 2019 TheHermeticVault.com</small> </p> </footer> </div> </aside> <main id=main-content> <div> <div class=page-image itemprop=image itemscope itemtype=https://schema.org/ImageObject style=--aspect-ratio:2.051282051282051> <img alt="El Caracol observatory temple, Chichen Itza, Mexico" class=webfeedsFeaturedVisual itemprop="url contentUrl" src=/img/pages/el-caracol-observatory.jpg> <meta content=1920 itemprop=width> <meta content=936 itemprop=height> <small>El Caracol observatory temple, Chichen Itza, Mexico</small> </div> <article> <h1 itemprop=headline>Making Boost.Signals2 More OOP‐Friendly</h1> <header> <h2 class=screenreader-only>Metadata</h2> <dl class="inline grey"> <div> <dt> <svg class="icon icon-clock-o" role=img> <desc>A clock.</desc> <use xlink:href=/icn/symbol-defs.ed79ff9f.svg#icon-clock-o /> </svg> Published: </dt> <dd> <time datetime=2015-04-17T00:00:00+03:00 itemprop=datePublished>17 Apr 2015</time>. </dd> </div> <div> <dt> <svg class="icon icon-newspaper-o" role=img> <desc>A newspaper.</desc> <use xlink:href=/icn/symbol-defs.ed79ff9f.svg#icon-newspaper-o /> </svg> Reading time: </dt> <dd> <time datetime=PT5M itemprop=timeRequired>5 minutes</time>. </dd> </div> <div class="new-line wrap-text"> <dt> <svg class="icon icon-tags" role=img> <title>Tags</title> <use xlink:href=/icn/symbol-defs.ed79ff9f.svg#icon-tags /> </svg> </dt> <dd> <ul class=inline> <li> <a href=/tag/boost class=main-muted rel=tag>Boost</a>, </li> <li> <a href=/tag/c%2B%2B class=main-muted rel=tag>C++</a>, </li> <li> <a href=/tag/design-patterns class=main-muted rel=tag>Design Patterns</a>, </li> <li> <a href=/tag/generic-programming class=main-muted rel=tag>Generic Programming</a>, </li> <li> <a href=/tag/oop class=main-muted rel=tag>OOP</a>. </li> </ul> </dd> </div> </dl> <meta content=3055 itemprop=wordCount> <meta content="Software Development" itemprop="articleSection about"> <meta content="Pavel Frolov" itemprop=author> <span itemprop=publisher itemscope itemtype=https://schema.org/Organization> <meta content="The Hermetic Vault" itemprop=name> <span itemprop=logo itemscope itemtype=https://schema.org/ImageObject> <link href=/img/pages/publisher-logo.png itemprop="url contentUrl"> <meta content=600 itemprop=width> <meta content=60 itemprop=height> </span> </span> <meta content=2019-10-19T21:09:00+03:00 itemprop=dateModified> </header> <div class=drop-letter itemprop=articleBody> <p>The <em>observer</em><sup id=fnref:fn-observer><a href=#fn:fn-observer class=footnote>1</a></sup> design pattern is by far the most popular and widely known among <em>behavioural patterns</em><sup id=fnref:fn-behavioural-patterns><a href=#fn:fn-behavioural-patterns class=footnote>2</a></sup>. Unfortunately, unlike other mainstream languages out there, the C++ standard library doesn’t provide out of the box observer implementation. Luckily, <a href=http://www.boost.org rel=external>Boost</a> contains <a href=http://www.boost.org/doc/libs/release/libs/signals2/ rel=external>Signals2</a>, a <em>signal/slot</em><sup id=fnref:fn-signals-slots><a href=#fn:fn-signals-slots class=footnote>3</a></sup> library which can serve as a basis for an observer. Using Signals2 as it is, however, is not so convenient in object‐oriented program due to the need of manually coded <em>register</em> and <em>notify</em> class methods for each of signal/slot pairs. This article suggests an <em>observable</em> <em>mixin</em><sup id=fnref:fn-mixin><a href=#fn:fn-mixin class=footnote>4</a></sup> which attempts to solve the outlined problem.</p> <h2 id=motivating-example>Motivating Example</h2> <p>Suppose we are crafting a <code class=highlighter-rouge>Window</code> class for a GUI application:</p> <figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>class</span> <span class=nc>Window</span> <span class=p>{</span>
<span class=nl>public:</span>
    <span class=kt>void</span> <span class=n>Show</span><span class=p>();</span>
    <span class=kt>bool</span> <span class=n>Close</span><span class=p>(</span><span class=kt>bool</span> <span class=n>force_close</span> <span class=o>=</span> <span class=nb>false</span><span class=p>);</span>
    <span class=c1>// ...</span>
<span class=p>};</span></code></pre></figure> <p>The <code class=highlighter-rouge>Window</code> class is probably wrapping some third‐party GUI library which is irrelevant for our example. What is relevant, however, is that there exists an <code class=highlighter-rouge>Application</code> class which wants to receive notifications whenever something happens in the <code class=highlighter-rouge>Window</code>:</p> <figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>class</span> <span class=nc>Application</span> <span class=p>{</span>
<span class=nl>public:</span>
    <span class=k>explicit</span> <span class=n>Application</span><span class=p>(</span><span class=n>Window</span><span class=o>&</span> <span class=n>window</span><span class=p>);</span>
    <span class=c1>// ...</span>

<span class=nl>private:</span>
    <span class=kt>void</span> <span class=n>OnWindowShow</span><span class=p>();</span>
    <span class=kt>bool</span> <span class=n>OnWindowClose</span><span class=p>(</span><span class=kt>bool</span> <span class=n>force_close</span><span class=p>);</span>
    <span class=c1>// ...</span>

    <span class=n>Window</span><span class=o>&</span> <span class=n>window_</span><span class=p>;</span>
    <span class=c1>// ...</span>
<span class=p>};</span></code></pre></figure> <p>For the sake of example, let’s say that we are interested in only two events: <code class=highlighter-rouge>ShowEvent</code> and <code class=highlighter-rouge>CloseEvent</code>:</p> <figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>using</span> <span class=n>ShowEvent</span> <span class=o>=</span> <span class=kt>void</span><span class=p>();</span>
<span class=k>using</span> <span class=n>CloseEvent</span> <span class=o>=</span> <span class=kt>bool</span><span class=p>(</span><span class=kt>bool</span> <span class=n>force_close</span><span class=p>);</span></code></pre></figure> <p>The <code class=highlighter-rouge>ShowEvent</code> is an information only event which is fired whenever the window is shown. On the other hand, the obviously purposed <code class=highlighter-rouge>CloseEvent</code> lets the user cancel the close operation by returning the value <code class=highlighter-rouge>false</code>, but only if the <code class=highlighter-rouge>force_close</code> flag is also <code class=highlighter-rouge>false</code> (otherwise the return value is ignored by the window).</p> <p>Let us define the two events mentioned along with corresponding <em>register</em> and <em>notify</em> methods with the help of Boost.Signals2 (note, in the simplest cases such as this, e.g. if there are no multiple handlers for a single event, we can use just <code class=highlighter-rouge>std::function</code> instead of <code class=highlighter-rouge>boost::signals2::signal</code>):</p> <figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>class</span> <span class=nc>Window</span> <span class=p>{</span>
<span class=nl>public:</span>
    <span class=kt>void</span> <span class=n>Show</span><span class=p>();</span>
    <span class=kt>bool</span> <span class=n>Close</span><span class=p>(</span><span class=kt>bool</span> <span class=n>force_close</span> <span class=o>=</span> <span class=nb>false</span><span class=p>);</span>
    <span class=c1>// ...</span>

    <span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span> <span class=n>F</span><span class=o>></span>
    <span class=n>boost</span><span class=o>::</span><span class=n>signals2</span><span class=o>::</span><span class=n>connection</span>
    <span class=n>RegisterShowObserver</span><span class=p>(</span><span class=n>F</span><span class=o>&&</span> <span class=n>f</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>show_signal_</span><span class=p>.</span><span class=n>connect</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>F</span><span class=o>></span><span class=p>(</span><span class=n>f</span><span class=p>));</span>
    <span class=p>}</span>

    <span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span> <span class=n>F</span><span class=o>></span>
    <span class=n>boost</span><span class=o>::</span><span class=n>signals2</span><span class=o>::</span><span class=n>connection</span>
    <span class=n>RegisterCloseObserver</span><span class=p>(</span><span class=n>F</span><span class=o>&&</span> <span class=n>f</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>close_signal_</span><span class=p>.</span><span class=n>connect</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>F</span><span class=o>></span><span class=p>(</span><span class=n>f</span><span class=p>));</span>
    <span class=p>}</span>

    <span class=c1>// More registrars...</span>

<span class=nl>protected:</span>
    <span class=kt>void</span> <span class=n>NotifyShowObservers</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
        <span class=n>show_signal_</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=n>boost</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=kt>bool</span><span class=o>></span> <span class=n>NotifyCloseObservers</span><span class=p>(</span><span class=kt>bool</span> <span class=n>force_close</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>close_signal_</span><span class=p>(</span><span class=n>force_close</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// More notifiers...</span>

<span class=nl>private:</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>signals2</span><span class=o>::</span><span class=n>signal</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>></span> <span class=n>show_signal_</span><span class=p>;</span>
    <span class=n>boost</span><span class=o>::</span><span class=n>signals2</span><span class=o>::</span><span class=n>signal</span><span class=o>&lt;</span><span class=kt>bool</span><span class=p>(</span><span class=kt>bool</span> <span class=n>force_close</span><span class=p>)</span><span class=o>></span> <span class=n>close_signal_</span><span class=p>;</span>
    <span class=c1>// More signals...</span>
<span class=p>};</span></code></pre></figure> <p>The main issue with the above code, as you can see, is that <em>register</em> and <em>notify</em> methods need to be written manually for each of events. And a real‐world window class can easily contain dozens of them! The next section will address this issue by presenting a convenient mixin class which automatically generates the needed methods for you given the list of event handler signatures. Think of <a href=http://docs.wxwidgets.org/trunk/overview_events.html#overview_events_eventtables rel=external>wxWidgets static event tables</a> or <a href=https://msdn.microsoft.com/en-us/library/0x0cx6b1.aspx rel=external>MFC message maps</a>, but without the use of macros. Or think of <a href=https://doc.qt.io/qt-5/signalsandslots.html rel=external>Qt signals and slots</a> or <a href="https://msdn.microsoft.com/en-us/library/ee2k0a7d(v=vs.120).aspx" rel=external>Visual C++ event handling</a>, but without the use of compiler extensions.</p> <h2 id=implementing-observable-mixin>Implementing Observable Mixin</h2> <p>Here is a <em>UML</em><sup id=fnref:fn-uml><a href=#fn:fn-uml class=footnote>5</a></sup> <em>class diagram</em><sup id=fnref:fn-class-diagram><a href=#fn:fn-class-diagram class=footnote>6</a></sup> which presents a high‐level view on what we will be discussing in this section. We’ll continue to use the window example from the previous section.</p> <figure> <svg viewBox="0 0 700 536" xmlns=http://www.w3.org/2000/svg><defs/><path d="M101 24h83l7 26.488h441V306H101V24z" stroke=#404040 fill=#FFDEAD stroke-width=1.5 /><path d="M101 50.488h90" stroke=#404040 stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=14 lengthAdjust=spacingAndGlyphs textLength=73 x=107 y=41.535 font-weight=bold>User Code</text><path d="M22 374h101l7 26.488h548V524H22V374z" stroke=#404040 fill=#FFDEAD stroke-width=1.5 /><path d="M22 400.488h108" stroke=#404040 stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=14 lengthAdjust=spacingAndGlyphs textLength=91 x=28 y=391.535 font-weight=bold>Library Code</text><path d="M382.5 68h233v78.043h-233z" stroke=#8b0000 fill=snow stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=12 lengthAdjust=spacingAndGlyphs textLength=64 x=467 y=86.602>Application</text><path d="M383.5 96.133h231m-231 8h231" stroke=#8b0000 stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=11 lengthAdjust=spacingAndGlyphs textLength=125 x=390.5 y=120.768>-void OnWindowShow()</text><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=11 lengthAdjust=spacingAndGlyphs textLength=217 x=390.5 y=137.723>-bool OnWindowClose(bool force_close)</text><path d="M396.5 212h219v78.043h-219z" stroke=#8b0000 fill=snow stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=12 lengthAdjust=spacingAndGlyphs textLength=44 x=484 y=230.602>Window</text><path d="M397.5 240.133h217m-217 8h217" stroke=#8b0000 stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=11 lengthAdjust=spacingAndGlyphs textLength=71 x=404.5 y=264.768>+void Show()</text><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=11 lengthAdjust=spacingAndGlyphs textLength=203 x=404.5 y=281.723>+bool Close(bool force_close = false)</text><path d="M248.5 229h113v44.133h-113z" stroke=#8b0000 fill=snow stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=12 lengthAdjust=spacingAndGlyphs textLength=103 x=253.5 y=247.602>WindowObservers</text><path d="M249.5 257.133h111m-111 8h111" stroke=#8b0000 stroke-width=1.5 /><path d="M267.5 63h75v88.176h-75z" stroke=#8b0000 fill=snow stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=12 lengthAdjust=spacingAndGlyphs textLength=44 x=283 y=81.602 font-style=italic>«enum»</text><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=12 lengthAdjust=spacingAndGlyphs textLength=4 x=303 y=99.734>:</text><path d="M268.5 109.266h73" stroke=#8b0000 stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=11 lengthAdjust=spacingAndGlyphs textLength=57 x=275.5 y=125.9>ShowEvent</text><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=11 lengthAdjust=spacingAndGlyphs textLength=59 x=275.5 y=142.856>CloseEvent</text><path d="M117 228h96v46.266h-96z" stroke=#8b0000 fill=snow stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=12 lengthAdjust=spacingAndGlyphs textLength=67 x=131.5 y=246.602 font-style=italic>«type alias»</text><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=12 lengthAdjust=spacingAndGlyphs textLength=86 x=122 y=264.734>ObserverTable</text><path d="M396 413h266v94.998H396z" stroke=#8b0000 fill=snow stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=12 lengthAdjust=spacingAndGlyphs textLength=66 x=430 y=431.602>Observable</text><path d="M535 410h130v20.133H535z" stroke=#404040 fill=#FFF stroke-dasharray="2 2"/><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=12 lengthAdjust=spacingAndGlyphs textLength=124 x=538 y=424.602 font-style=italic>Observers: typename</text><path d="M397 441.133h264" stroke=#8b0000 stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=11 lengthAdjust=spacingAndGlyphs textLength=200 x=404 y=457.768>-signals_ : Observers::ObserverTable</text><path d="M397 466.088h264" stroke=#8b0000 stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=11 lengthAdjust=spacingAndGlyphs textLength=241 x=404 y=482.723>+boost::signals2::connection Register(F&& f)</text><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=11 lengthAdjust=spacingAndGlyphs textLength=250 x=404 y=499.678>#Observer::Result Notify(Args&&... args) const</text><path d="M38 430h258v61.088H38z" stroke=#8b0000 fill=snow stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=12 lengthAdjust=spacingAndGlyphs textLength=53 x=77.5 y=448.602>Observer</text><path d="M175 427h124v20.133H175z" stroke=#404040 fill=#FFF stroke-dasharray="2 2"/><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=12 lengthAdjust=spacingAndGlyphs textLength=118 x=178 y=441.602 font-style=italic>Signature: typename</text><path d="M39 458.133h256" stroke=#8b0000 stroke-width=1.5 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=11 lengthAdjust=spacingAndGlyphs textLength=242 x=46 y=474.768>-signal_ : boost::signals2::signal&lt;Signature></text><path d="M39 483.088h256" stroke=#8b0000 stroke-width=1.5 /><path d="M501.53 159.22c.85 17.37 1.79 36.45 2.59 52.62" stroke=#8b0000 fill=none /><path d="M500.88 146.05l-3.698 6.19 4.291 5.795 3.699-6.19-4.292-5.795z" stroke=#8b0000 fill=#FFF /><path d="M305 151.38v64.21" stroke=#8b0000 fill=none /><path d="M305 228.65l4-6-4-6-4 6 4 6z" stroke=#8b0000 fill=#8B0000 /><path d="M235.11 251h-21.99" stroke=#8b0000 fill=none /><path d="M248.3 251l-6-4-6 4 6 4 6-4z" stroke=#8b0000 fill=#8B0000 /><path d="M395.92 460.5h-79.38" stroke=#8b0000 fill=none stroke-dasharray="7 7"/><path d="M316.16 467.5l-20-7 20-7v14z" stroke=#8b0000 fill=none /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=13 lengthAdjust=spacingAndGlyphs textLength=51 x=324.5 y=452.068 font-style=italic>«friend»</text><path d="M510.22 290.06c3.18 28.68 7.62 68.73 11.38 102.7m7-.44l-4.76 20.65-9.16-19.11 13.92-1.54z" stroke=#8b0000 fill=none /><path d="M298.36 273.41c-5.72 22.87-10.74 59.24 5.64 84.59 6.09 9.43 44.9 28.15 88.62 46.97" stroke=#8b0000 fill=none stroke-dasharray="7 7"/><path d="M395.56 398.62l15.68 14.25-21.15-1.37 5.47-12.88z" stroke=#8b0000 fill=none /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=13 lengthAdjust=spacingAndGlyphs textLength=42 x=384 y=337.568 font-style=italic>«bind»</text><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=13 lengthAdjust=spacingAndGlyphs textLength=196 x=307 y=352.879>Observers → WindowObservers</text><path d="M186.78 429.76c25.73-38.69 70.53-106.05 96.97-145.81" stroke=#8b0000 fill=none /><path d="M291.01 273.04l-6.653 2.782.009 7.211 6.653-2.782-.009-7.211z" stroke=#8b0000 fill=#8B0000 /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=13 lengthAdjust=spacingAndGlyphs textLength=22 x=204.366 y=417.052>1..*</text><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=13 lengthAdjust=spacingAndGlyphs textLength=8 x=262.35 y=295.713>1</text><path d="M162.62 274.04c-1.36 13.77-2.93 31.87-3.62 47.96-1.24 29.02.5 61.46 2.67 87.54" stroke=#8b0000 fill=none stroke-dasharray="7 7"/><path d="M168.66 409.18l-5.13 20.56-8.81-19.27 13.94-1.29z" stroke=#8b0000 fill=none /><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=13 lengthAdjust=spacingAndGlyphs textLength=42 x=170.5 y=337.568 font-style=italic>«bind»</text><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=13 lengthAdjust=spacingAndGlyphs textLength=59 x=162 y=352.879>Signature</text><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=13 lengthAdjust=spacingAndGlyphs textLength=8 x=145.96 y=296.952>1</text><text fill=#404040 font-family="alegreya-sans, sans-serif" font-size=13 lengthAdjust=spacingAndGlyphs textLength=22 x=127.308 y=417.028>1..*</text></svg> <figcaption>Observable Mixin UML Class Diagram</figcaption> </figure> <h3 id=the-windowobservers-class>The WindowObservers Class</h3> <p>Obviously enough, we can’t just put our signals into <em>homogeneous</em> container like <code class=highlighter-rouge>std::vector</code> because of different event signatures. Fortunately, the C++ standard library provides <code class=highlighter-rouge>std::tuple</code>, an integer‐indexed <em>heterogeneous container</em> which solves our needs (alternatively, we can use a tag‐indexed heterogeneous container, such as <code class=highlighter-rouge>boost::fusion::map</code>). With the help of <code class=highlighter-rouge>std::tuple</code>, we can define an observer table for our <code class=highlighter-rouge>Window</code> class as shown below:</p> <figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>struct</span> <span class=n>WindowObservers</span> <span class=p>{</span>
    <span class=k>enum</span> <span class=p>{</span> <span class=n>ShowEvent</span><span class=p>,</span> <span class=n>CloseEvent</span> <span class=p>};</span>
    <span class=k>using</span> <span class=n>ObserverTable</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>tuple</span><span class=o>&lt;</span>
        <span class=n>Observer</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>></span><span class=p>,</span>  <span class=c1>// ShowEvent</span>
        <span class=n>Observer</span><span class=o>&lt;</span><span class=kt>bool</span><span class=p>(</span><span class=kt>bool</span> <span class=n>force_close</span><span class=p>)</span><span class=o>></span>  <span class=c1>// CloseEvent</span>
    <span class=o>></span><span class=p>;</span>
<span class=p>};</span></code></pre></figure> <p>Here, we are making use of enumeration to index observers. This approach is not ideal: an insertion or removal of an observer from the tuple definition may cause a nasty bug if we are not careful enough to adjust the enumeration accordingly. The tag‐based heterogeneous containers are more immune to this issue due to the fact that the tag is mentioned explicitly as part of container element type.</p> <h3 id=the-observer-class-template>The Observer Class Template</h3> <p>The <code class=highlighter-rouge>Observer</code> type used in the above code fragment is just a simple convenience wrapper for <code class=highlighter-rouge>boost::signals2::signal</code>:</p> <figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span> <span class=n>Signature</span><span class=o>></span> <span class=k>class</span> <span class=nc>Observer</span> <span class=p>{</span>
<span class=nl>public:</span>
    <span class=n>Observer</span><span class=p>(</span><span class=k>const</span> <span class=n>Observer</span><span class=o>&</span><span class=p>)</span> <span class=o>=</span> <span class=k>delete</span><span class=p>;</span>
    <span class=n>Observer</span><span class=o>&</span> <span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>Observer</span><span class=o>&</span><span class=p>)</span> <span class=o>=</span> <span class=k>delete</span><span class=p>;</span>
    <span class=n>Observer</span><span class=p>()</span> <span class=o>=</span> <span class=k>default</span><span class=p>;</span>

<span class=nl>private:</span>
    <span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span> <span class=n>Observers</span><span class=o>></span> <span class=k>friend</span> <span class=k>class</span> <span class=nc>Observable</span><span class=p>;</span>

    <span class=k>using</span> <span class=n>Signal</span> <span class=o>=</span> <span class=n>boost</span><span class=o>::</span><span class=n>signals2</span><span class=o>::</span><span class=n>signal</span><span class=o>&lt;</span><span class=n>Signature</span><span class=o>></span><span class=p>;</span>
    <span class=k>using</span> <span class=n>SignalResult</span> <span class=o>=</span> <span class=k>typename</span> <span class=n>Signal</span><span class=o>::</span><span class=n>result_type</span><span class=p>;</span>

    <span class=n>Signal</span> <span class=n>signal_</span><span class=p>;</span>
<span class=p>};</span></code></pre></figure> <p>Aside from the signal itself, the type contains a couple of convenience type aliases and a friend declaration for the <code class=highlighter-rouge>Observable</code> class.</p> <h3 id=the-observable-class-template>The Observable Class Template</h3> <p>The <code class=highlighter-rouge>Observable</code> class is what makes use of our <code class=highlighter-rouge>WindowObservers</code> structure to generate the corresponding registration and notification methods:</p> <figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span> <span class=n>Observers</span><span class=o>></span> <span class=k>class</span> <span class=nc>Observable</span> <span class=p>{</span>
<span class=nl>private:</span>
    <span class=k>using</span> <span class=n>ObserverTable</span> <span class=o>=</span> <span class=k>typename</span> <span class=n>Observers</span><span class=o>::</span><span class=n>ObserverTable</span><span class=p>;</span>

<span class=nl>public:</span>
    <span class=c1>// Registers an observer.</span>
    <span class=k>template</span><span class=o>&lt;</span><span class=kt>size_t</span> <span class=n>ObserverId</span><span class=p>,</span> <span class=k>typename</span> <span class=n>F</span><span class=o>></span>
    <span class=n>boost</span><span class=o>::</span><span class=n>signals2</span><span class=o>::</span><span class=n>connection</span>
    <span class=n>Register</span><span class=p>(</span><span class=n>F</span><span class=o>&&</span> <span class=n>f</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>std</span><span class=o>::</span><span class=n>get</span><span class=o>&lt;</span><span class=n>ObserverId</span><span class=o>></span><span class=p>(</span><span class=n>signals_</span><span class=p>).</span><span class=n>signal_</span><span class=p>.</span><span class=n>connect</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>F</span><span class=o>></span><span class=p>(</span><span class=n>f</span><span class=p>));</span>
    <span class=p>}</span>

<span class=nl>protected:</span>
    <span class=n>Observable</span><span class=p>()</span> <span class=o>=</span> <span class=k>default</span><span class=p>;</span>

    <span class=c1>// Notifies observers.</span>
    <span class=k>template</span><span class=o>&lt;</span><span class=kt>size_t</span> <span class=n>ObserverId</span><span class=p>,</span> <span class=k>typename</span><span class=p>...</span> <span class=n>Args</span><span class=o>></span>
    <span class=k>typename</span> <span class=n>std</span><span class=o>::</span><span class=n>tuple_element</span><span class=o>&lt;</span><span class=n>ObserverId</span><span class=p>,</span> <span class=n>ObserverTable</span><span class=o>>::</span><span class=n>type</span><span class=o>::</span><span class=n>SignalResult</span>
    <span class=n>Notify</span><span class=p>(</span><span class=n>Args</span><span class=o>&&</span><span class=p>...</span> <span class=n>args</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>std</span><span class=o>::</span><span class=n>get</span><span class=o>&lt;</span><span class=n>ObserverId</span><span class=o>></span><span class=p>(</span><span class=n>signals_</span><span class=p>).</span><span class=n>signal_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>Args</span><span class=o>></span><span class=p>(</span><span class=n>args</span><span class=p>)...);</span>
    <span class=p>}</span>

<span class=nl>private:</span>
    <span class=n>ObserverTable</span> <span class=n>signals_</span><span class=p>;</span>
<span class=p>};</span></code></pre></figure> <p>The <code class=highlighter-rouge>Observable</code> class maintains a table (<code class=highlighter-rouge>std::tuple</code> in our case) of observers the definition of which is passed as class template parameter <code class=highlighter-rouge>Observers</code>. An example of such an argument is the <code class=highlighter-rouge>WindowObervers</code> structure defined earlier.</p> <p>The class provides <code class=highlighter-rouge>Register</code> method which is used obviously for observers registration. The function takes an arbitrary callable object (whatever Boost.Signals2 happens to support as a slot type), represented by <code class=highlighter-rouge>F&& f</code> parameter, and an index into the tuple (<code class=highlighter-rouge>ObserverId</code> template parameter). The function returns <code class=highlighter-rouge>boost::signals2::connection</code> object which can be used later to unregister the observer.</p> <p>The class also has <code class=highlighter-rouge>Notify</code> method which invokes callable objects registered earlier for particular observer kind (which is given by the means of the <code class=highlighter-rouge>ObserverId</code> template argument). The <code class=highlighter-rouge>Notify</code> method forwards its function arguments (<code class=highlighter-rouge>args</code>) to the callable object. The function returns the result of the last slot called, wrapped into <code class=highlighter-rouge>boost::optional</code> (this is the default behaviour of <code class=highlighter-rouge>boost::signals2::signal</code>; see the Boost.Signals2 documentation in case you need an advanced return semantic).</p> <p>The constructor of the class is made protected because this class is not intended to be used on its own.</p> <h3 id=the-window-class>The Window Class</h3> <p>Our <code class=highlighter-rouge>Window</code> class now derives from <code class=highlighter-rouge>Observable</code> class template parametrised by <code class=highlighter-rouge>WindowsObservers</code>. This give us a possibility to use <code class=highlighter-rouge>Register</code> and <code class=highlighter-rouge>Notify</code> methods on <code class=highlighter-rouge>Window</code> instances.</p> <figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>class</span> <span class=nc>Window</span><span class=o>:</span> <span class=k>public</span> <span class=n>Observable</span><span class=o>&lt;</span><span class=n>WindowObservers</span><span class=o>></span> <span class=p>{</span>
<span class=nl>public:</span>
    <span class=kt>void</span> <span class=n>Show</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// ...</span>
        <span class=n>Notify</span><span class=o>&lt;</span><span class=n>WindowObservers</span><span class=o>::</span><span class=n>ShowEvent</span><span class=o>></span><span class=p>();</span>
    <span class=p>}</span>

    <span class=kt>bool</span> <span class=n>Close</span><span class=p>(</span><span class=kt>bool</span> <span class=n>force_close</span> <span class=o>=</span> <span class=nb>false</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>const</span> <span class=n>boost</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=kt>bool</span><span class=o>></span> <span class=n>can_close</span><span class=p>{</span>
            <span class=n>Notify</span><span class=o>&lt;</span><span class=n>WindowObservers</span><span class=o>::</span><span class=n>CloseEvent</span><span class=o>></span><span class=p>(</span><span class=n>force_close</span><span class=p>)</span> <span class=p>};</span>
        <span class=k>const</span> <span class=kt>bool</span> <span class=n>closing</span><span class=p>{</span> <span class=n>force_close</span> <span class=o>||</span> <span class=o>!</span><span class=n>can_close</span> <span class=o>||</span> <span class=o>*</span><span class=n>can_close</span> <span class=p>};</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>closing</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Actually close the window.</span>
            <span class=c1>// ...</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>closing</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// ...</span>
<span class=p>};</span></code></pre></figure> <h3 id=the-application-class>The Application Class</h3> <p>Finally, the application class registers the callbacks for <code class=highlighter-rouge>WindowObservers::ShowEvent</code> and <code class=highlighter-rouge>WindowObservers::CloseEvent</code> events:</p> <figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=k>class</span> <span class=nc>Application</span> <span class=p>{</span>
<span class=nl>public:</span>
    <span class=k>explicit</span> <span class=n>Application</span><span class=p>(</span><span class=n>Window</span><span class=o>&</span> <span class=n>window</span><span class=p>)</span> <span class=o>:</span> <span class=n>window_</span><span class=p>(</span><span class=n>window</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>window_</span><span class=p>.</span><span class=n>Register</span><span class=o>&lt;</span><span class=n>WindowObservers</span><span class=o>::</span><span class=n>ShowEvent</span><span class=o>></span><span class=p>([</span><span class=k>this</span><span class=p>]()</span> <span class=p>{</span>
            <span class=n>OnWindowShow</span><span class=p>();</span>
        <span class=p>});</span>
        <span class=n>window</span><span class=p>.</span><span class=n>Register</span><span class=o>&lt;</span><span class=n>WindowObservers</span><span class=o>::</span><span class=n>CloseEvent</span><span class=o>></span><span class=p>([</span><span class=k>this</span><span class=p>](</span><span class=kt>bool</span> <span class=n>force_close</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>OnWindowClose</span><span class=p>(</span><span class=n>force_close</span><span class=p>);</span>
        <span class=p>});</span>
    <span class=p>}</span>

    <span class=c1>// ...</span>

<span class=nl>private:</span>
    <span class=kt>void</span> <span class=n>OnWindowShow</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// ...</span>
    <span class=p>}</span>

    <span class=kt>bool</span> <span class=n>OnWindowClose</span><span class=p>(</span><span class=kt>bool</span> <span class=n>force_close</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// ...</span>
        <span class=k>return</span> <span class=n>force_close</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>Window</span><span class=o>&</span> <span class=n>window_</span><span class=p>;</span>
        <span class=c1>// ...</span>
<span class=p>};</span></code></pre></figure> <h2 id=putting-it-all-together>Putting It All Together</h2> <p>Here is a self‐sufficient test program which puts together the above code snippets:</p> <figure class=highlight><pre><code class=language-c-- data-lang=c++><span class=c1>//-----------------------------------------------------------------------------</span>
<span class=c1>// Observable mixin.</span>
<span class=c1>//-----------------------------------------------------------------------------</span>

<span class=cp>#include &lt;tuple>
#include &lt;utility>
</span>
<span class=cp>#include &lt;boost/signals2.hpp>
</span>

<span class=c1>// Convenience wrapper for boost::signals2::signal.</span>
<span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span> <span class=n>Signature</span><span class=o>></span> <span class=k>class</span> <span class=nc>Observer</span> <span class=p>{</span>
<span class=nl>public:</span>
    <span class=n>Observer</span><span class=p>(</span><span class=k>const</span> <span class=n>Observer</span><span class=o>&</span><span class=p>)</span> <span class=o>=</span> <span class=k>delete</span><span class=p>;</span>
    <span class=n>Observer</span><span class=o>&</span> <span class=k>operator</span><span class=o>=</span><span class=p>(</span><span class=k>const</span> <span class=n>Observer</span><span class=o>&</span><span class=p>)</span> <span class=o>=</span> <span class=k>delete</span><span class=p>;</span>
    <span class=n>Observer</span><span class=p>()</span> <span class=o>=</span> <span class=k>default</span><span class=p>;</span>

<span class=nl>private:</span>
    <span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span> <span class=n>Observers</span><span class=o>></span> <span class=k>friend</span> <span class=k>class</span> <span class=nc>Observable</span><span class=p>;</span>

    <span class=k>using</span> <span class=n>Signal</span> <span class=o>=</span> <span class=n>boost</span><span class=o>::</span><span class=n>signals2</span><span class=o>::</span><span class=n>signal</span><span class=o>&lt;</span><span class=n>Signature</span><span class=o>></span><span class=p>;</span>
    <span class=k>using</span> <span class=n>SignalResult</span> <span class=o>=</span> <span class=k>typename</span> <span class=n>Signal</span><span class=o>::</span><span class=n>result_type</span><span class=p>;</span>

    <span class=n>Signal</span> <span class=n>signal_</span><span class=p>;</span>
<span class=p>};</span>


<span class=c1>// Generic observable mixin - users must derive from it.</span>
<span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span> <span class=n>Observers</span><span class=o>></span> <span class=k>class</span> <span class=nc>Observable</span> <span class=p>{</span>
<span class=nl>private:</span>
    <span class=k>using</span> <span class=n>ObserverTable</span> <span class=o>=</span> <span class=k>typename</span> <span class=n>Observers</span><span class=o>::</span><span class=n>ObserverTable</span><span class=p>;</span>

<span class=nl>public:</span>
    <span class=c1>// Registers an observer.</span>
    <span class=k>template</span><span class=o>&lt;</span><span class=kt>size_t</span> <span class=n>ObserverId</span><span class=p>,</span> <span class=k>typename</span> <span class=n>F</span><span class=o>></span>
    <span class=n>boost</span><span class=o>::</span><span class=n>signals2</span><span class=o>::</span><span class=n>connection</span>
    <span class=n>Register</span><span class=p>(</span><span class=n>F</span><span class=o>&&</span> <span class=n>f</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>std</span><span class=o>::</span><span class=n>get</span><span class=o>&lt;</span><span class=n>ObserverId</span><span class=o>></span><span class=p>(</span><span class=n>signals_</span><span class=p>).</span><span class=n>signal_</span><span class=p>.</span><span class=n>connect</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>F</span><span class=o>></span><span class=p>(</span><span class=n>f</span><span class=p>));</span>
    <span class=p>}</span>

<span class=nl>protected:</span>
    <span class=n>Observable</span><span class=p>()</span> <span class=o>=</span> <span class=k>default</span><span class=p>;</span>

    <span class=c1>// Notifies observers.</span>
    <span class=k>template</span><span class=o>&lt;</span><span class=kt>size_t</span> <span class=n>ObserverId</span><span class=p>,</span> <span class=k>typename</span><span class=p>...</span> <span class=n>Args</span><span class=o>></span>
    <span class=k>typename</span> <span class=n>std</span><span class=o>::</span><span class=n>tuple_element</span><span class=o>&lt;</span><span class=n>ObserverId</span><span class=p>,</span> <span class=n>ObserverTable</span><span class=o>>::</span><span class=n>type</span><span class=o>::</span><span class=n>SignalResult</span>
    <span class=n>Notify</span><span class=p>(</span><span class=n>Args</span><span class=o>&&</span><span class=p>...</span> <span class=n>args</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>std</span><span class=o>::</span><span class=n>get</span><span class=o>&lt;</span><span class=n>ObserverId</span><span class=o>></span><span class=p>(</span><span class=n>signals_</span><span class=p>).</span><span class=n>signal_</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>forward</span><span class=o>&lt;</span><span class=n>Args</span><span class=o>></span><span class=p>(</span><span class=n>args</span><span class=p>)...);</span>
    <span class=p>}</span>

<span class=nl>private:</span>
    <span class=n>ObserverTable</span> <span class=n>signals_</span><span class=p>;</span>
<span class=p>};</span>


<span class=c1>//-----------------------------------------------------------------------------</span>
<span class=c1>// Example usage.</span>
<span class=c1>//-----------------------------------------------------------------------------</span>

<span class=cp>#include &lt;iostream>
</span>

<span class=c1>// Defines observers for Windows class.</span>
<span class=k>struct</span> <span class=n>WindowObservers</span> <span class=p>{</span>
    <span class=k>enum</span> <span class=p>{</span> <span class=n>ShowEvent</span><span class=p>,</span> <span class=n>CloseEvent</span> <span class=p>};</span>
    <span class=k>using</span> <span class=n>ObserverTable</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>tuple</span><span class=o>&lt;</span>
        <span class=n>Observer</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>></span><span class=p>,</span>                 <span class=c1>// ShowEvent</span>
        <span class=n>Observer</span><span class=o>&lt;</span><span class=kt>bool</span><span class=p>(</span><span class=kt>bool</span> <span class=n>force_close</span><span class=p>)</span><span class=o>></span>  <span class=c1>// CloseEvent</span>
    <span class=o>></span><span class=p>;</span>
<span class=p>};</span>


<span class=c1>// Window: our Observable.</span>
<span class=k>class</span> <span class=nc>Window</span><span class=o>:</span> <span class=k>public</span> <span class=n>Observable</span><span class=o>&lt;</span><span class=n>WindowObservers</span><span class=o>></span> <span class=p>{</span>
<span class=nl>public:</span>
    <span class=kt>void</span> <span class=n>Show</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>"Window::Show called."</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
        <span class=n>Notify</span><span class=o>&lt;</span><span class=n>WindowObservers</span><span class=o>::</span><span class=n>ShowEvent</span><span class=o>></span><span class=p>();</span>
        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>"Window::Show handled."</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kt>bool</span> <span class=n>Close</span><span class=p>(</span><span class=kt>bool</span> <span class=n>force_close</span> <span class=o>=</span> <span class=nb>false</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>"Window::Close called: force_close == "</span>
            <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>boolalpha</span> <span class=o>&lt;&lt;</span> <span class=n>force_close</span> <span class=o>&lt;&lt;</span> <span class=s>"."</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>

        <span class=k>const</span> <span class=n>boost</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=kt>bool</span><span class=o>></span> <span class=n>can_close</span><span class=p>{</span>
            <span class=n>Notify</span><span class=o>&lt;</span><span class=n>WindowObservers</span><span class=o>::</span><span class=n>CloseEvent</span><span class=o>></span><span class=p>(</span><span class=n>force_close</span><span class=p>)</span> <span class=p>};</span>
        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>"Window::Close handled. can_close == "</span>
            <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>boolalpha</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=o>!</span><span class=n>can_close</span> <span class=o>||</span> <span class=o>*</span><span class=n>can_close</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=s>"."</span>
            <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>

        <span class=k>const</span> <span class=kt>bool</span> <span class=n>closing</span><span class=p>{</span> <span class=n>force_close</span> <span class=o>||</span> <span class=o>!</span><span class=n>can_close</span> <span class=o>||</span> <span class=o>*</span><span class=n>can_close</span> <span class=p>};</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>closing</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// Actually close the window.</span>
            <span class=c1>// ...</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>closing</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>};</span>

<span class=c1>// Application: our Observer.</span>
<span class=k>class</span> <span class=nc>Application</span> <span class=p>{</span>
<span class=nl>public:</span>
    <span class=k>explicit</span> <span class=n>Application</span><span class=p>(</span><span class=n>Window</span><span class=o>&</span> <span class=n>window</span><span class=p>)</span> <span class=o>:</span> <span class=n>window_</span><span class=p>(</span><span class=n>window</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Register window observers.</span>
        <span class=n>window_</span><span class=p>.</span><span class=n>Register</span><span class=o>&lt;</span><span class=n>WindowObservers</span><span class=o>::</span><span class=n>ShowEvent</span><span class=o>></span><span class=p>([</span><span class=k>this</span><span class=p>]()</span> <span class=p>{</span>
            <span class=n>OnWindowShow</span><span class=p>();</span>
        <span class=p>});</span>
        <span class=n>window</span><span class=p>.</span><span class=n>Register</span><span class=o>&lt;</span><span class=n>WindowObservers</span><span class=o>::</span><span class=n>CloseEvent</span><span class=o>></span><span class=p>([</span><span class=k>this</span><span class=p>](</span><span class=kt>bool</span> <span class=n>force_close</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>OnWindowClose</span><span class=p>(</span><span class=n>force_close</span><span class=p>);</span>
        <span class=p>});</span>
    <span class=p>}</span>

<span class=nl>private:</span>
    <span class=kt>void</span> <span class=n>OnWindowShow</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>"Application::OnWindowShow called."</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kt>bool</span> <span class=n>OnWindowClose</span><span class=p>(</span><span class=kt>bool</span> <span class=n>force_close</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>"Application::WindowClose called: force_close == "</span>
            <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>boolalpha</span> <span class=o>&lt;&lt;</span> <span class=n>force_close</span> <span class=o>&lt;&lt;</span> <span class=s>"."</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
        <span class=k>return</span> <span class=n>force_close</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>Window</span><span class=o>&</span> <span class=n>window_</span><span class=p>;</span>
<span class=p>};</span>


<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>Window</span> <span class=n>window</span><span class=p>;</span>
    <span class=n>Application</span> <span class=n>application</span><span class=p>{</span> <span class=n>window</span> <span class=p>};</span>

    <span class=c1>// Notify observers.</span>
    <span class=n>window</span><span class=p>.</span><span class=n>Show</span><span class=p>();</span>
    <span class=c1>//...</span>
    <span class=n>window</span><span class=p>.</span><span class=n>Close</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
    <span class=n>window</span><span class=p>.</span><span class=n>Close</span><span class=p>(</span><span class=nb>true</span><span class=p>);</span>
<span class=p>}</span></code></pre></figure> <h2 id=conclusion>Conclusion</h2> <p>In this article we have seen how modern C++ features, in particular, <em>variadic templates</em> and <em>perfect forwarding</em> allow us to implement a generic variant of observer pattern without the use of either macros or proprietary compiler extensions.</p> <p>I have also experimented with alternative implementations, namely, the one based on <code class=highlighter-rouge>boost::fusion::map</code> instead of <code class=highlighter-rouge>std::tuple</code> and the other which uses <code class=highlighter-rouge>std::function</code> instead of <code class=highlighter-rouge>boost::signals2::signal</code>. You can find them in a <a href=https://gist.github.com/psfrolov/07887b173776ebbb4aac rel=external>gist</a>.</p> <hr> <h2 class=screenreader-only id=footnotes>Footnotes</h2> <div class=footnotes> <ol> <li id=fn:fn-observer> <p>A software design pattern in which an object, called the subject, maintains a list of its dependents, called observers, and notifies them automatically of any state changes, usually by calling one of their methods. The <a href=https://sourcemaking.com/design_patterns/observer rel=external>observer pattern</a> is also a key part in the model–view–controller (MVC) architectural pattern. <a href=#fnref:fn-observer class=reversefootnote>↑</a></p> </li> <li id=fn:fn-behavioural-patterns> <p>Used to manage relationships, interaction, algorithms and responsibilities between objects. The <a href=https://sourcemaking.com/design_patterns/behavioral_patterns rel=external>behavioural pattern</a> focuses on the interaction between the cooperating objects in a manner that the objects are communicating while maintaining loose coupling. <a href=#fnref:fn-behavioural-patterns class=reversefootnote>↑</a></p> </li> <li id=fn:fn-signals-slots> <p>A language construct for communication between objects which makes it easy to implement the Observer pattern while avoiding boilerplate code. For example, GUI widgets can send signals containing event information which can be received by other controls using special functions known as slots. <a href=#fnref:fn-signals-slots class=reversefootnote>↑</a></p> </li> <li id=fn:fn-mixin> <p>A class that acts as the parent class, containing the desired functionality. A subclass can then inherit or simply reuse this functionality, but without creating a rigid, single ‘is a’ relationship (<a href=https://en.wikipedia.org/wiki/Mixin rel=external>Wikipedia</a>). <a href=#fnref:fn-mixin class=reversefootnote>↑</a></p> </li> <li id=fn:fn-uml> <p>A general‐purpose, developmental, modeling language in the field of software engineering, that is intended to provide a standard way to visualize the design of a system (<a href=https://en.wikipedia.org/wiki/Unified_Modeling_Language rel=external>Wikipedia</a>). <a href=#fnref:fn-uml class=reversefootnote>↑</a></p> </li> <li id=fn:fn-class-diagram> <p>In the UML a type of static structure diagram that describes the structure of a system by showing the system’s classes, their attributes, operations (or methods), and the relationships among objects (<a href=https://en.wikipedia.org/wiki/Class_diagram rel=external>Wikipedia</a>). <a href=#fnref:fn-class-diagram class=reversefootnote>↑</a></p> </li> </ol> </div> </div> <aside> <h2 class=screenreader-only>Comments</h2> <div id=disqus_thread></div> <script>var disqus_config=function(){this.page.url="https://thehermeticvault.com/software-development/making-boost-signals2-more-oop-friendly",this.page.identifier="urn:uuid:b5e5a495-748d-41bd-b31f-5b06229fdf09",this.page.title="Making Boost.Signals2 More OOP‐Friendly"};!function(){var e=document,t=e.createElement('script');t.src='https://arkfps.disqus.com/embed.js',t.setAttribute('data-timestamp',+new Date),(e.head||e.body).appendChild(t)}()</script> <noscript><i>Please enable JavaScript to view the comments.</i></noscript> </aside> </article> <script type=application/ld+json> { "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/boost", "name": "Boost" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/making-boost-signals2-more-oop-friendly", "name": "Making Boost.Signals2 More OOP‐Friendly" } } ] } </script> <script type=application/ld+json> { "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/c%2B%2B", "name": "C++" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/making-boost-signals2-more-oop-friendly", "name": "Making Boost.Signals2 More OOP‐Friendly" } } ] } </script> <script type=application/ld+json> { "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/design-patterns", "name": "Design Patterns" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/making-boost-signals2-more-oop-friendly", "name": "Making Boost.Signals2 More OOP‐Friendly" } } ] } </script> <script type=application/ld+json> { "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/generic-programming", "name": "Generic Programming" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/making-boost-signals2-more-oop-friendly", "name": "Making Boost.Signals2 More OOP‐Friendly" } } ] } </script> <script type=application/ld+json> { "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "item": { "@id": "https://thehermeticvault.com", "name": "Home" } }, { "@type": "ListItem", "position": 2, "item": { "@id": "https://thehermeticvault.com/tag/oop", "name": "OOP" } }, { "@type": "ListItem", "position": 3, "item": { "@id": "https://thehermeticvault.com/software-development/making-boost-signals2-more-oop-friendly", "name": "Making Boost.Signals2 More OOP‐Friendly" } } ] } </script> </div> </main> <script> window.onpageshow = (evt) => {
        'use strict';
        // Scroll view to main content area of page if not coming from history.
        if (window.location.hash) return;  // ignore URLs with fragment
        const nav = performance.getEntriesByType('navigation');
        if (nav.length) {  // for Chrome/Opera, Firefox, Edge
          if (nav[0].type === 'back_forward') return;
        } else if (evt.persisted) { // for Safari
          return;
        }
        const main = document.getElementById('main-content');
        if (main.scrollIntoView) main.scrollIntoView({ behavior: 'smooth' });
      }; </script> </body> </html> 